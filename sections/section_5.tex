\section{Section 5} \label{sec:section_5}

    This section focuses in leveraging the stability of a graph to create a stable partition which maximum number
    of parts does not grow with the size of the graph.
    In order to do so, we first prove the existence of a partition which parts satisfy a property which we prove stronger
    then regularity: \emph{excellence}.
    We proceed to formalize this concept.

    \begin{definition}[Definition 5.2(a)]
        Let $G$ be a finite graph with the non-$k_*$-property.
        We say that $A \subseteq G$ is $\epsilon$-\emph{good} when for every $b \in G$ the truth value
        $t = t(b, A) \in \parcurly{0, 1}$ satisfies
        $\parstraight{\overline{B}_{A,b}} = \parstraight{\parcurly{a\in A \mid aRb \not\equiv t}} < \epsilon |A|$.
    \end{definition}

    \begin{definition}[Definition 5.2(b)]
        Let $G$ be a finite graph with the non-$k_*$-property.
        We say that $A \subseteq G$ is $(\epsilon, \zeta)$-\emph{excellent} when $A$ is $\epsilon$-good and, if $B$ is
        $\zeta$-good, then the truth value $t = t(B,A)$ satisfies $\parstraight{\parcurly{a \in A \mid t(a,B) \neq t(A,B)}} < \epsilon |A|$.
        In particular, we say $A$ is $\epsilon$-\emph{excellent} if $A$ is $(\epsilon, \epsilon)$-excellent.
    \end{definition}

    We now make some observations about these two properties.

    \begin{remark}
        For comparison with the properties studied in the previous section, a set being $\epsilon$-good is equivalent to the
        set being $f$-indivisible with $f(n) = \epsilon n$, while $\epsilon$-indivisibility is a much stronger condition then
        $\epsilon$-goodness, as for large enough $n$, we have that $n^\epsilon < \epsilon n$.

        On the other hand, $\epsilon$-excellence carries some kind of reciprocity with other good (and in particular,
        excellent) sets, which makes it particularly suitable for studying \regularity~between pairs of sets.
        While independence and goodness only bound the number of exceptions with each vertex of the graph independently,
        excellence of a set $A$ also ensures that the truth values of each of its vertex with respect to each
        good set in the graph remains mostly the same.
        \Cref{fig:good_not_excellent} shows an example of an $\epsilon$-good set that, as it does not satisfy this
        reciprocity condition with another good set, it is not $\epsilon$-excellent.
    \end{remark}

    \begin{remark} \label{rmk:excellence_imply_little_exceptions}
        If $A, B \subseteq G$ are two (not necessarily disjoint) subsets of vertices
        with $A$ $(\epsilon, \epsilon')$-excellent and $B$ $\epsilon'$-good set, then the number of exceptional edges between $A$ and $B$,
        i.e. these vertex pairs that do not follow $t(A,B)$, is relatively small:
        \[
            \parstraight{\parcurly{\text{Exceptional edges between } A \text{ and } B}} <
                \epsilon |A| |B| + (1- \epsilon) |A| \epsilon' |B| = \parround{\epsilon + \parround{1-\epsilon} \epsilon'} |A| |B|
        \]
        A relevant example is that of two disjoint $\epsilon$-excellent sets, in which case we have that the fraction
        of exceptional edges between them is less than $2\epsilon$.
        If they are not disjoint, we can still use the same reasoning to conclude that the fraction of exceptional edges
        is less than $2 \epsilon \frac{\parstraight{A} \parstraight{B}}{e(A,B)} < 8 \epsilon$, since
        $e(A,B) > \frac{\parstraight{A} \parstraight{B}}{4}$.
        \todo{Discuss with Luis, this may be reduced but I am not sure.}
    \end{remark}

    \begin{remark}
        A final important remark, is the fact that differently then most \regular~properties, $\epsilon$-excellence is
        not monotonic. \todo{Lluis: això està ben dit?}
        That is, in general, for $\epsilon < \epsilon'$, a set being $\epsilon$-excellent does not imply
        it being also $\epsilon'$-excellent (and trivially neither the converse).
        See \Cref{fig:excellence_is_not_monotonic} for a counter example to the monotonicity of this property.

        On the other hand, the non-symmetric $(\epsilon, \epsilon')$-excellence satisfies some sort of monotonicity.
        That is, if a given set is $(\epsilon_1, \epsilon'_1)$-excellent, then it is also
        $(\epsilon_2, \epsilon'_2)$-excellent for all $\epsilon_1 \leq \epsilon_2$ and $\epsilon'_1 \geq \epsilon'_2$,
        since restricting the condition on the goodness of the relevant good sets ($\epsilon'_1$ to $\epsilon'_2$)
        takes less of such sets into account, and relaxing the condition on the \say{exceptional truth values}
        ($\epsilon_1$ to $\epsilon_2$) only enlarges the error accepted.
    \end{remark}

    The first step towards constructing a partition of sets with such property, is to prove their existence under the
    stability condition.
    Similar to \Cref{lem:existance_of_indivisible_sets} in \Cref{sec:section_4}, we will prove this by assuming
    the converse and getting to contradiction with the tree bound.

    We actually show two versions of the same lemma on existence of excellent sets.
    \Cref{lem:existance_of_excellent_subsets} is slightly more readable, while
    \Cref{lem:existance_of_excellent_subsets_fixed_size_choices} is the one we will be using for further
    proofs, as it fixes the possibles sizes of the resulting set.
    For that reason, in this section we only prove the first one, and leave the proof of the other in
    \Cref{sec:appendix_other_proofs}.

    \begin{lemma}[Claim 5.4] \label{lem:existance_of_excellent_subsets}
        Let $G$ be a finite graph with the non-$k_{*}$-order property.
        Let $\zeta \leq \frac{1}{2^{k_{**}}}$, $\epsilon \in \parround{0, \frac{1}{2}}$.
        Then, for every $A \subseteq G$ with $|A| \geq \frac{1}{\epsilon^{k_{**}}}$ there exists an $(\epsilon, \zeta)$-excellent
        subset $A' \subseteq A$ such that $|A'| \geq \epsilon^{k_{**}-1} |A|$.
        \begin{proof}
            Suppose the converse.
            We use this fact to build sets $\parcurly{b_\eta \mid \eta \in \parcurly{0,1}^{<k_{**}}}$ and
            $\parcurly{A_\eta \mid \eta \in \parcurly{0,1}^{\leq k_{**}}}$ on induction over $k<k_{**}$, where $k = |\eta|$,
            satisfying:
            \begin{enumerate}
                \item\label{itm:existance_of_excellent_subsets.1} $A_{\Partriangle{\cdot}} = A$.
                \item\label{itm:existance_of_excellent_subsets.2} $B_\eta$ is a $\zeta$-good set witnessing that $A_\eta$ is not
                    $(\epsilon, \zeta)$-excellent, for $k < k_{**}$.
                \item\label{itm:existance_of_excellent_subsets.3} $A_{\eta \frown \Partriangle{i}} = \parcurly{a \in A_\eta \mid t(a, B_\eta) \equiv i}$
                    for all $i \in \parcurly{0,1}$ and $k < k_{**}$.
                \item\label{itm:existance_of_excellent_subsets.4} $\parstraight{A_{\eta \frown \Partriangle{i}}} \geq \epsilon |A_\eta|$
                    for all $i \in \parcurly{0,1}$ and $k < k_{**}$.
                \item\label{itm:existance_of_excellent_subsets.5} $|A_\eta| \geq \epsilon^k |A|$, for $k \leq k_{**}$.
                \item\label{itm:existance_of_excellent_subsets.6} $A_\eta = A_{\eta \frown \Partriangle{0}} \sqcup A_{\eta \frown \Partriangle{1}}$,
                    for $k < k_{**}$.
                \item\label{itm:existance_of_excellent_subsets.7} $\overline{A_k} = \parcurly{A_\eta \mid \eta \in \parcurly{0,1}^k}$ is a partition of $A$,
                    for $k \leq k_{**}$.
            \end{enumerate}
            First of all, notice that at each step, the non-$(\epsilon, \zeta)$-excellence of $A_\eta$ comes by IH
            from \dref{itm:existance_of_excellent_subsets.1} or \dref{itm:existance_of_excellent_subsets.5},
            and thus allows the existence of $B_\eta$ in \dref{itm:existance_of_excellent_subsets.2}.
            \dref{itm:existance_of_excellent_subsets.4} follows the definition of $A_{\eta \frown \Partriangle{i}}$ in
            \dref{itm:existance_of_excellent_subsets.3} and the fact $B_\eta$ is witnessing that $A_\eta$ is not $(\epsilon, \zeta)$-excellent.
            Applying recursively this last point we obtain \dref{itm:existance_of_excellent_subsets.5}.
            Finally, by definition \dref{itm:existance_of_excellent_subsets.3}, we have the disjoint union
            \dref{itm:existance_of_excellent_subsets.6} which ensures
            the partition \dref{itm:existance_of_excellent_subsets.7}.

            Now, our goal is to build two sequences $\parcurly{b_\eta \mid \eta \in \parcurly{0,1}^{<k_{**}}}$ and
            $\parcurly{a_\eta \mid \eta \in \parcurly{0,1}^{k_{**}}}$ to contradict the tree bound $k_{**}$.
            First of all, notice that, for $\eta \in \parcurly{0,1}^{k_{**}}$
            \[
                |A_\eta| \geq \epsilon^{k_{**}} |A| \geq
                \epsilon^{k_{**}} \frac{1}{\epsilon^{k_{**}}} = 1
            \]
            So, for each $\eta \in \parcurly{0,1}^{k_{**}}$, $A_\eta \neq \emptyset$ and we may choose an $a_\eta \in A_\eta$.
            Now, for $\nu \in \parcurly{0,1}^{<k_{**}}$ and $\eta \in \parcurly{0,1}^{k_{**}}$ such that $\nu \triangleleft \eta$, let
            \[
                U_{\nu,\eta} = \parcurly{b \in B_\nu \mid a_\eta R b \not\equiv t(a_\eta, B_\nu)}
            \]
            be the subset of elements of $B_\nu$ that do not relate with $a_\eta$ in the expected way.
            By $\zeta$-goodness of $B_\nu$, $|U_{\nu, \eta}| < \zeta |B_\nu|$, and thus for every $\nu \in \parcurly{0,1}^{<k_{**}}$,
            \[
                \parstraight{\bigcup\parcurly{ U_{\nu,\eta} \mid \nu \triangleleft \eta \in \parcurly{0,1}^{k_{**}}}} <
                2^{k_{**}} \zeta |B_\nu| \leq |B_\nu|
            \]
            We may choose $b_\nu \in B_\nu \setminus \bigcup\parcurly{U_{\nu,\eta} \mid \nu \triangleleft \eta \in \parcurly{0,1}^{k_{**}}}$,
            for all $\nu \in \parcurly{0,1}^{<k_{**}}$.
            Finally, the sequences $\Partriangle{a_\eta \mid \eta \in \parcurly{0,1}^{k_{**}}}$ and $\Partriangle{b_\nu \mid \nu \in \parcurly{0,1}^{<k_{**}}}$
            satisfy that $\forall \eta, \nu$ such that $\nu \frown \Partriangle{i} \triangleleft \eta$, $\parround{a_\eta R b_\nu}^i$
            by \dref{itm:existance_of_excellent_subsets.3} and \dref{itm:existance_of_excellent_subsets.6}.
            This contradicts \Cref{def:tree_bound} of tree bound $k_{**}$.
        \end{proof}
    \end{lemma}

    \begin{remark}
        The two sequences $\Partriangle{a_\eta \mid \eta \in \parcurly{0,1}^{k_{**}}}$ and $\Partriangle{b_\nu \mid \nu \in \parcurly{0,1}^{<k_{**}}}$
        are not necessarily disjoint.
        This is the reason why, for this to work, the \Cref{def:k-tree}, and consequently \Cref{def:k_order_property},
        do not take this condition.
        Although it makes the non-$k$-order assumption on the graph stricter, this also allows the definition of excellence
        to work with respect to the set itself (as it is good by definition).
        Thus, the resulting partition will not only satisfy \regularity~between different parts, but actually ensures
        that the parts are \regular~within themsleves.
    \end{remark}

    \begin{lemma}[Claim 5.4.1] \label{lem:existance_of_excellent_subsets_fixed_size_choices}
        Let $G$ be a finite graph with the non-$k_{*}$-order property.
        Let $\zeta < \frac{1}{2^{k_{**}}}$, $\epsilon \in \parround{0, \frac{1}{2}}$.
        Let $\Partriangle{m\ell \mid \ell \in \parcurly{0, \dots, k_{**}}}$ be a decreasing sequence of natural numbers such that
        $\epsilon m_{\ell} \geq m_{\ell+1}$ for all $\ell \in \parcurly{0, \dots, k_{**}-1}$ and $m_{k_{**}} \geq 1$.
        % Notice that we needed to add m_{k_{**}} to the sequence, since it is needed in (c)' in the paper
        % (m_{l+1} may take that value!!).
        Then, for every $A \subseteq G$ with $|A| \geq m_0$ there exists
        $\parround{\frac{m_{\ell+1}}{m_{\ell}}, \zeta}$-excellent subset $A' \subseteq A$ such that $|A'| = m_\ell$ for
        some $\ell \in \parcurly{0, \dots, k_{**}-1}$.
    \end{lemma}

    Now, we can get the first version of a partition by applying the previous lemma recursively, until the remainder is too
    small for the condition on the size of the graph to be satisfied.

    \begin{lemma}[Claim 5.14.1] \label{lem:existance_of_excellent_partition}
        Let $G$ be a finite graph with the non-$k_{*}$-order property.
        Let $\epsilon \in \parround{0, \frac{1}{2}}$ and $\epsilon' \leq \frac{1}{2^{k_{**}}}$.
        Let $A \subseteq G$ such that $|A| = n$.
        Let $\Partriangle{m\ell \mid \ell \in \parcurly{0, \dots, k_{**}}}$ be a decreasing sequence of natural numbers such that
        $\epsilon m_{\ell} \geq m_{\ell+1}$ for all $\ell \in \parcurly{0, \dots, k_{**}-1}$ and $m_{k_{**}} \geq 1$.
        Denote $m_* \coloneqq m_0$ and $m_{**} \coloneqq m_{k_{**}}$.
        Then, there is a partition $\overline{A} = \Partriangle{A_j \mid j \in \parcurly{1, \dots, j(*)}}$ with remainder
        $B = A \setminus \bigcup_{j < j(*)} A_j$ such that:
        \begin{enumerate}[label=(\alph*), ref=\alph*]
            \item \label{itm:existance_of_excellent_partition.a} For all $j \in \parcurly{1, \dots, j(*)}$, $|A_j| \in \Partriangle{m\ell \mid \ell \in \parcurly{0, \dots, k_{**}-1}}$.
            \item \label{itm:existance_of_excellent_partition.b} For all $i \neq j \in \parcurly{1, \dots, j(*)}$, $A_i \cap A_j = \emptyset$.
            \item \label{itm:existance_of_excellent_partition.c} For all $j \in \parcurly{1, \dots, j(*)}$, $A_j$ is $\parround{\epsilon, \epsilon'}$-excellent.
            \item \label{itm:existance_of_excellent_partition.d} $|B| < m_*$.
        \end{enumerate}
        \begin{proof}
            Apply \Cref{lem:existance_of_excellent_subsets_fixed_size_choices} recursively to the remainder
            $A \setminus \bigcup_{i < j} A_i$, to obtain $A_j$ at each step.
            The process stops at $j(*)$ when the remainder is smaller than $m_0$, and thus the lemma cannot be applied.
            Notice that, since $\frac{m_\ell}{m_{\ell-1}} \leq \epsilon$, $\parround{\frac{m_\ell}{m_{\ell-1}}, \epsilon'}$-excellence
            implies $\parround{\epsilon, \epsilon'}$-excellence.
        \end{proof}
    \end{lemma}

    \todo{Say that if $A$ is smaller than $m_0$, then the partition is empty and $B = A$.}

    The next step is refining this partition to obtain an equitable partition.
    In order to do so, we first show that any random sample of a given size from an excellent set is still excellent
    with high probability, at the cost of a slightly reduced excellence (\dref{itm:equitable_partition_of_excellent_parts.2} of
    \Cref{lem:equitable_partition_of_excellent_parts}).
    Then, we use this result in a union-bound argument to show that we can actually fully partition the excellent set into
    pieces of equal size (\dref{itm:equitable_partition_of_excellent_parts.3} of
    \Cref{lem:equitable_partition_of_excellent_parts}), which are still excellent.
    Finally, \Cref{lem:existance_of_excellent_partition_with_equal_size} applies this result to the partition from
    \Cref{lem:existance_of_excellent_partition} to get an equitable excellent partition.

    Before getting to it, we prove the following calculus result, which will be required in the subsequent proof.
    The statement comes from~\cite{no_me_acuerdo} \todo{To do.}and, for completeness, we provide here a short proof.

    \begin{lemma} \label{lem:ineq_5.13}
        For $k > 1$, $\zeta, \eta \in \parround{0,1}$ the function $f(m) = m^k \cdot e^{-2 \zeta^2 m}$ satisfies
        $f(m) \leq \eta$ for all $m \geq \frac{1}{\zeta^2}\parround{k \log{\frac{1}{\zeta^2} k} - \log{\eta}}$.
        \begin{proof}
            First of all, notice that for $m = \frac{1}{\zeta^2}\parround{k \log{\frac{1}{\zeta^2} k} - \log{\eta}}$,
            \[
                f(m) = \frac{m^k}{e^{2 \zeta^2 m}}
                     = \frac{\parround{\frac{1}{\zeta^2}\parround{k \log{\frac{1}{\zeta^2} k} - \log{\eta}}}^k}{
                        \parround{\frac{k}{\zeta^2}}^{2k} \eta^{-2}}
                     \leq \frac{k^k \parround{\log{\frac{k}{\zeta^2}\parround{\frac{1}{\eta}}^{\frac{1}{k}}}}^k}
                        {k^k \parround{\frac{k}{\zeta^2} \parround{\frac{1}{\eta}}^{\frac{1}{k}}}^k} \eta
                     < \eta
            \]
            To conclude, we prove that $f$ is decreasing for larger values of $m$:
            \[
                f'(m)
                    = \frac{k m^{k-1} e^{2 \zeta^2 m} - 2 \zeta^2 m^k e^{2 \zeta^2 m}}{\parround{e^{2 \zeta^2 m}}^2}
                    = \parround{k - 2m\zeta^2} \frac{m^{k-1}}{e^{2 \zeta^2 m}}
            \]
            The second factor is always positive, and $m > \frac{k}{\zeta^2} > \frac{k}{2\zeta^2}$, proving that $f'(m) < 0$
            and thus $f$ is decreasing.
        \end{proof}
    \end{lemma}

    \begin{lemma}[Claim 5.13] \label{lem:equitable_partition_of_excellent_parts}
        Let $G$ be a finite graph with the non-$k_{*}$-order property.
        Then:
        \begin{enumerate}[label=(\alph*), ref=\alph*]
            \item \label{itm:equitable_partition_of_excellent_parts.1} For every $\epsilon \in \parround{0, \frac{1}{2}}$,
                $\zeta \in \parround{0, \frac{1}{2} - \epsilon}$, $\xi \in \parround{0, 1}$ and
                $m \geq \frac{1}{\zeta^2}\parround{k_* \log{\frac{1}{\zeta^2}k_*} - \log{\xi}}$,
                if $A \subseteq G$ is an $\epsilon$-good subset of size $n \geq m$,
                then a random subset $A' \subseteq A$ of size $m$ is $(\epsilon + \zeta)$-good with probability $1-\xi$.
            \item \label{itm:equitable_partition_of_excellent_parts.1*} Moreover, such $A'$ satisfies $t(b, A') = t(b, A)$ for all $b \in G$.
            \item \label{itm:equitable_partition_of_excellent_parts.2} For every $\zeta \in \parcurly{0, \frac{1}{2}}$ and $\zeta' < \zeta$, there is
                $\epsilon_1 = \epsilon_1(\zeta, \zeta')$ such that for every $\epsilon < \epsilon' \leq \epsilon_1$, if
                \begin{itemize}
                    \item $A \subseteq G$ is $\parcurly{\epsilon, \epsilon'}$-excellent.
                    \item $A' \subseteq A$ is $\parcurly{\epsilon + \zeta'}$-good.
                \end{itemize}
                then, $A'$ is $\parround{\epsilon + \zeta, \epsilon'}$-excellent.
            \item \label{itm:equitable_partition_of_excellent_parts.3} For all $\zeta \in \parround{0, \frac{1}{2}}$, $\zeta' < \zeta$, $r \geq 1$ and for all
                $\epsilon < \epsilon'$ small enough (in the sense of the previous point) there exists
                $N = N\parround{k_{*}, \zeta', r}$ such that, if $|A| = n > N$, $r$ divides $n$ and $A$ is
                $\parround{\epsilon, \epsilon'}$-excellent, there exists a partition into $r$ disjoint pieces of equal
                size, each of which is $\parround{\epsilon + \zeta, \epsilon'}$-excellent.
        \end{enumerate}
        \begin{proof}
        \begin{enumerate}[label=(\alph*), ref=\alph*]
            \item For each $b \in G$, we say that $B_{A,b}$ is \emph{bad} if $\parstraight{B_{A,b}} \geq \epsilon \parstraight{A'}$.
                For each bad $B_{A,b}$, let $X_{A,b}$ be the event that
                $\parstraight{B_{A,b}} \geq \parround{\epsilon + \zeta} \parstraight{A'}$ for a random subset
                $A' \subseteq A$ of size $m$.
                Notice that $X_{A,b}$ is modelled by a hypergeometric distribution, and so the probability of
                upperly deviating from the mean by $\zeta$, can be modeled by
                \[
                    P\parround{X_{A,b} = 1} \leq e^{-2\zeta^2 m}
                \]
                Now we want to study the random variable $X$ counting the number of events $X_{A,b}$ that are satisfied.
                That is, $X = \sum_{\text{bad } B_{A,b}} X_{A,b}$.
                We compute the expectation
                \[
                    \mathbb{E}[X] = \sum_{\text{bad } B_{A,b}} \mathbb{E}[X_{A,b}]
                        = \sum_{\text{bad } B_{A,b}} P\parround{X_{A,b} = 1}
                        \leq \sum_{\text{bad } B_{A,b}} e^{-2\zeta^2 m}
                \]
                Following \dref{itm:k_order_propery_bounds_BAbs.2}, the number of intersections of bad $B_{A,b}$'s with $A'$, can be bounded
                by $m^{k_*}$.
                Thus, using the First Moment Method, we have that:
                \[
                    P\parround{X \geq 1} \leq \mathbb{E}[X] \leq m^{k_*} \cdot e^{-2\zeta^2 m} \leq \xi
                \]
                Last inequality follows \Cref{lem:ineq_5.13} using the lower bound on $m$.
                Thus, with probability at least $1 - \xi$, we have that $A'$ is $(\epsilon + \zeta)$-good.
            \item Suppose that $A'$ is the subset described in \dref{itm:equitable_partition_of_excellent_parts.1}.
                We proved that, such set satisfies
                \[
                    \parstraight{A' \cap B_{A,b}} < \parround{\epsilon + \zeta} \parstraight{A'}
                \]
                for all $b \in G$ such that $\parstraight{B_{A,b}} \geq \epsilon m$.
                Thus, we have that:
                \begin{itemize}
                    \item If $\parstraight{B_{A,b}} < \epsilon m$, then
                        $\parstraight{\parcurly{a \in A' \mid a R b \not \equiv t(b,A)}} \leq \parstraight{B_{A,b}}
                        < \epsilon m < \parround{\epsilon + \zeta} m$.
                    \item If $\parstraight{B_{A,b}} \geq \epsilon m$, then
                        $\parstraight{\parcurly{a \in A' \mid a R b \not \equiv t(b,A)}} = \parstraight{A' \cap B_{A,b}}
                        < \parround{\epsilon + \zeta} m$.
                \end{itemize}
            We conclude that $t(b,A) = t(b,A')$ for all $b \in G$.
            \item Let $B \subseteq G$ be an $\epsilon'$-good set.
                We first upperbound the number of exceptional vertices of $B$ with respect to $A'$:
                \begin{align*}
                    \parstraight{\parcurly{b \in B \mid t(b, A') \not\equiv t(B,A)}}
                        & = \parstraight{\parcurly{b \in B \mid t(b, A) \not\equiv t(B,A)}} \\
                        & \leq \frac{\parround{\epsilon + \parround{1 - \epsilon} \epsilon'}\parstraight{A}\parstraight{B}}
                            {\parround{1 - \epsilon}\parstraight{A}} \\
                        & = \parround{\epsilon' + \frac{\epsilon}{1 - \epsilon}}\parstraight{B}
                \end{align*}
                The first equality follows \dref{itm:equitable_partition_of_excellent_parts.1*}, and the first inequality follows from
                \Cref{rmk:excellence_imply_little_exceptions} for the numerator, and taking the worst case of only
                $(1 - \epsilon) \parstraight{A}$ exceptional edges per exceptional $b \in B$
                (considering that $A$ is $\epsilon$-good).

                Now, let $Q$ be the set of exceptional vertices of $A'$ with respect to $B$, i.e.:
                \[
                    Q = \parcurly{a \in A' \mid t(a, B) \not\equiv t(A, B)}
                \]
                We want to double-count the number of exceptional edges between $Q$ and $B$.
                On one hand, we have that:
                \[
                    \parstraight{\parcurly{(a,b) \in Q \times B \mid t(a, b) \not\equiv t(A, B)}} <
                    \parround{\epsilon' + \frac{\epsilon}{1 - \epsilon}} \parstraight{B} \parstraight{Q} +
                    \parround{1 - \epsilon' - \frac{\epsilon}{1 - \epsilon}} \parstraight{B} \parround{\epsilon + \zeta'} \parstraight{A'}
                \]
                The first term is the maximum number of exceptional edges associated to exceptional $b \in B$
                (considering all edges exceptional), while the second term bounds the number of exceptional edges of
                non-exceptional $b \in B$, using the fact that $A'$ is $(\epsilon + \zeta')$-good.

                On the other hand, we have that:
                \[
                    \parstraight{\parcurly{(a,b) \in Q \times B \mid t(a, b) \not\equiv t(A, B)}} \geq
                    \parstraight{Q} \parround{1 - \epsilon'} \parstraight{B}
                \]
                which follows $B$ being $\epsilon'$-good.

                Putting it all together:
                \[
                    \parround{1 - \epsilon' - \epsilon' - \frac{\epsilon}{1 - \epsilon}} \parstraight{B} \parstraight{Q} <
                    \parround{1 - \epsilon' + \frac{\epsilon}{1 - \epsilon}} \parround{\epsilon + \zeta'} \parstraight{B} \parstraight{A'}
                \]
                So, we have that:
                \begin{align*}
                    \parstraight{Q} & < \frac{\parround{1 - \epsilon' - \frac{\epsilon}{1 - \epsilon}}}
                                        {\parround{1 - \epsilon' - \frac{\epsilon}{1 - \epsilon}} - \epsilon'}
                                        \parround{\epsilon + \zeta'} \parstraight{A'} \\
                                    & = \parround{1 + \frac{\epsilon'}{1 - 2\epsilon' - \frac{\epsilon}{1 - \epsilon}}}
                                        (\epsilon + \zeta') |A'|
                \end{align*}
                Notice that $f(\epsilon, \epsilon') \coloneqq \frac{\epsilon'}{1 - 2\epsilon' - \frac{\epsilon}{1 - \epsilon}}$
                decreases with $\epsilon$ and $\epsilon'$.
                In particular,
                \[
                    f(\epsilon, \epsilon') \overset{\epsilon' \to 0}{\longrightarrow} 0
                \]
                and $\epsilon' > \epsilon$.
                Then,
                \[
                    \parstraight{Q} < \parround{\epsilon + \parround{\underbrace{\epsilon f(\epsilon, \epsilon')}_{\to 0} +
                    \underbrace{\parround{1 + f(\epsilon, \epsilon')}}_{\to 1}} \zeta'} |A'|
                    \overset{\epsilon' \to 0}{\longrightarrow} \parround{\epsilon + \zeta'} |A'|
                \]
                So, there exists an $\epsilon_1 = \epsilon_1(\zeta, \zeta')$ small enough such that for all
                $(\epsilon <)$ $\epsilon' \leq \epsilon_1$, we have that $\parstraight{Q} < \parround{\epsilon + \zeta} |A'|$,
                and since $A'$ is $(\epsilon + \zeta')$-good, and thus $(\epsilon + \zeta)$-good, we conclude that
                $A'$ is $(\epsilon + \zeta, \epsilon')$-excellent. \todo{Mention that in the next claim we show valid values for this.}
            \item Let $\zeta, \zeta', \epsilon, \epsilon'$ and $r$ be given satisfying the conditions of the statement.
                Set $\xi = \frac{1}{r + 1}$.
                We will see that the condition
                $n > N = N\parround{k_{*}, \zeta', r} \coloneqq r \frac{1}{\zeta'^2}\parround{k_* \log{\frac{1}{\zeta'^2}k_*} - \log{\frac{1}{r + 1}}}$
                is sufficient.
                First of all, randomly choose a function $h: A \longrightarrow \parcurly{1, \dots, r-1}$ such that
                for all $s < n$ we have that $\parstraight{\parcurly{a \in A \mid h(a) = s}} = \frac{n}{r}$.
                Since $h$ is random, each $A' \in [A]^\frac{n}{r}$ has the same probability of being part of the partition
                induced by $h$, i.e. to satisfy $A' = h^{-1}(s)$ for some $s \in \parcurly{1, \dots, r-1}$.
                Since each element of the partition $A'$ has size
                $\frac{n}{r} > \frac{N}{r} = \frac{1}{\zeta'^2}\parround{k_* \log{\frac{1}{\zeta'^2}k_*} - \log{\xi}}$,
                we can apply \dref{itm:equitable_partition_of_excellent_parts.1} to get that
                \[
                    P\parround{A' \text{ is not } \parround{\epsilon + \zeta'}\text{-good}} < \xi
                \]
                In particular, since $A$ is $(\epsilon, \epsilon')$-excellent, it follows \dref{itm:equitable_partition_of_excellent_parts.2} that if $A'$ is
                $\parround{\epsilon + \zeta'}$-good then it is also $\parround{\epsilon + \zeta, \epsilon'}$-excellent, so:
                \[
                    P\parround{A' \text{ is not } \parround{\epsilon + \zeta, \epsilon'}\text{-excellent}} < \xi
                \]
                To conclude, by the union bound, we have that:
                \begin{align*}
                    P\parround{\bigcup_{s < r} h^{-1}(s) \text{ is not } \parround{\epsilon + \zeta, \epsilon'}\text{-excellent}}
                        & \leq \sum_{s < r} P\parround{h^{-1}(s) \text{ is not } \parround{\epsilon + \zeta, \epsilon'}\text{-excellent}} \\
                        & < r \xi = \frac{r}{r+1} < 1
                \end{align*}
                All in all, there is a non-zero chance that the partition satisfies the statement, i.e. there exists at least one.
        \end{enumerate}
        \end{proof}
    \end{lemma}

    \begin{remark}[Remark 5.13.1] \label{rmk:value_for_equitable_partition_of_excellent_parts}
        For following applications, we would like to use \dref{itm:equitable_partition_of_excellent_parts.3} from
        \Cref{lem:equitable_partition_of_excellent_parts} with $\epsilon' > k \parround{\epsilon + \zeta}$, for an arbitrarily large $k \in \naturals$.
        Notice that if $\epsilon, \zeta' \leq \frac{1}{t}, \epsilon' \leq \frac{1}{t'}$ and $t > t' \geq 5$, then:
        \begin{enumerate}[label=(\alph*), ref=\alph*]
            \item $\frac{\epsilon}{1-\epsilon} \leq \frac{\frac{1}{t}}{1-\frac{1}{t}} = \frac{\frac{1}{t}}{\frac{t-1}{t}}
                = \frac{1}{t-1}$
            \item $1 - 2 \epsilon' - \frac{\epsilon}{1-\epsilon} \geq 1 - \frac{2}{t'} - \frac{1}{t-1} > 1 - \frac{3}{t'-1}
                = \frac{t'-4}{t'-1}$
            \item \label{itm:value_for_equitable_partition_of_excellent_parts.c} $\parround{1 + \frac{\epsilon'}{1 - 2 \epsilon' - \frac{\epsilon}{1-\epsilon}}}
                < 1 + \frac{\epsilon'}{1 - \frac{3}{t'-1}}
                = \parround{1 + \frac{t'-1}{t'-4} \epsilon'} \parround{\epsilon + \zeta'}$
        \end{enumerate}
        Then, by requiring $\frac{1}{t} \leq \frac{1}{4k}\epsilon'$ we have that
        \begin{align*}
            \epsilon + \zeta'
                & \leq \frac{2}{t} \leq 2 \parround{\frac{1}{4k}\epsilon'} = \frac{1}{2} \parround{\frac{1}{k}\epsilon'} \\
                & < \frac{t'-4}{t'- 3} \frac{1}{k} \epsilon' = \frac{1}{k} \frac{\epsilon'}{1 + \frac{1}{t'-4}} \\
                & < \frac{1}{k} \frac{\epsilon'}{1 + \frac{t'-1}{t'}\frac{1}{t'-4}} = \frac{1}{k} \frac{\epsilon'}{1 + \frac{t'-1}{t'-4}\frac{1}{t'}} \\
                & \leq \frac{1}{k} \frac{\epsilon'}{1 + \frac{t'-1}{t'-4}\epsilon'}
        \end{align*}
        i.e., we have:
        \[
            \parround{1 + \frac{t'-1}{t'-4} \epsilon'} \parround{\epsilon + \zeta'} < \frac{1}{k} \epsilon'
        \]
        which by \dref{itm:value_for_equitable_partition_of_excellent_parts.c} gives us:
        \[
            \parround{1 + \frac{\epsilon'}{1 - 2 \epsilon' - \frac{\epsilon}{1-\epsilon}}} < \frac{1}{k} \epsilon'
        \]
        All in all, a sufficient condition, for the lemma to hold under the constraint $\epsilon' \geq k \parround{\epsilon + \zeta}$, is:
        \[
            \epsilon, \zeta' \leq \frac{1}{4k} \epsilon' \quad \text{ and } \quad \epsilon' \leq \frac{1}{5}
        \]
    \end{remark}

    We use this fact to reformulate point \dref{itm:equitable_partition_of_excellent_parts.3} of
    \Cref{lem:equitable_partition_of_excellent_parts} as:

    \begin{lemma}[Claim 5.13.2(3)] \label{lem:existance_of_equitable_excellent_subpartition}
        Let $G$ be a finite graph with the non-$k_*$-property.
        For all $k, r \geq 1$, $\epsilon' \leq \frac{1}{5}$ and $\epsilon \leq \frac{1}{4k} \epsilon'$, there exists
        $N = N\parround{k, k_*, \epsilon', r}$ large enough such that, for all $n > N$ and $r$ dividing $n$,
        if $A \subseteq G$ is $\parround{\epsilon, \epsilon'}$-excellent, with $|A| = n$, then there exists a
        partition into $r$ disjoint pieces of equal size, each of which is $\parround{\frac{\epsilon'}{k}, \epsilon'}$-excellent.
        \begin{proof}
            Choose any $\zeta' \leq \frac{1}{4k} \epsilon'$ and set $N \coloneqq N_{\ref{lem:equitable_partition_of_excellent_parts}}\parround{k_*, \zeta', r}$.
            \Cref{rmk:value_for_equitable_partition_of_excellent_parts} sufficiency condition is satisfied,
            \dref{itm:equitable_partition_of_excellent_parts.3} from \Cref{lem:equitable_partition_of_excellent_parts}
            holds and we are done.
        \end{proof}
    \end{lemma}

    \begin{remark}
        A sufficient condition for $N_{\ref{lem:existance_of_equitable_excellent_subpartition}}$ to be large enough is
        to choose $\zeta' = \frac{1}{4k} \epsilon'$ in which case
        $N_{\ref{lem:existance_of_equitable_excellent_subpartition}}\parround{k, k_*, \epsilon', r} \coloneqq
        N_{\ref{lem:equitable_partition_of_excellent_parts}}\parround{k_*, \frac{1}{4k} \epsilon', r}$
    \end{remark}

    Now we proceed to refine the partition from \Cref{lem:existance_of_excellent_partition} into an equitable one.
    Notice that, in the conditions of the following couple of lemmas, we require a decreasing sequence of integers which
    has no direct appearance in the consequences of the statements.
    This is because it is part of the construction, and proving its existence in later results (in the context of the
    rest of the other variables) avoids unnecessary relaxations of the bounds or approximation errors.

    \begin{lemma}[Claim 5.14.1a] \label{lem:existance_of_excellent_partition_with_equal_size}
        Let $G$ be a finite graph with the non-$k_{*}$-order property.
        Let $\epsilon' \leq \min \parround{\frac{1}{5}, \frac{1}{2^{k_{**}}}}$ and $\epsilon \leq \frac{1}{4k} \epsilon'$ for some $k > 1$.
        Let $A \subseteq G$ such that $|A| = n$.
        Let $\Partriangle{m\ell \mid \ell \in \parcurly{0, \dots, k_{**}}}$ be a decreasing sequence of natural numbers such that
        $\epsilon m_{\ell} \geq m_{\ell+1}$ for all $\ell \in \parcurly{0, \dots, k_{**}-1}$, $m_{k_{**}} \geq 1$,
        $m_{**} \coloneqq m_{k_{**}} \mid m_\ell$ for all $\ell \in \parcurly{0, \dots, k_{**}}$,
        $m_{k_{**}-1} > N\parround{k, k_*, \epsilon', \frac{m_*}{m_{**}}}$
        (in the sense of \Cref{lem:existance_of_equitable_excellent_subpartition}), and $n \geq m_0$.
        Let $m_* \coloneqq m_0$.
        Then, for some $i(*) \leq \frac{n}{m_{**}}$, there is a partition $\overline{A} = \Partriangle{A_i \mid i \in \parcurly{1, \dots, i(*)}}$
        with remainder $B = A \setminus \bigcup \overline{A}$ such that:
        \begin{enumerate}[label=(\alph*), ref=\alph*]
            \item \label{itm:existance_of_excellent_partition_with_equal_size.a} For all $i \in \parcurly{1, \dots, i(*)}$, $|A_i| = m_{**}$.
            \item \label{itm:existance_of_excellent_partition_with_equal_size.c} For all $i \in \parcurly{1, \dots, i(*)}$, $A_i$ is $\parround{\frac{\epsilon'}{k}, \epsilon'}$-excellent.
            \item \label{itm:existance_of_excellent_partition_with_equal_size.d} $|B| < m_*$.
        \end{enumerate}
        \begin{proof}
            Use \Cref{lem:existance_of_excellent_partition} to obtain a partition
            $\overline{A}' = \Partriangle{A_j' \mid j \in \parcurly{1, \dots, j(*)}}$ and remainder $B$ with $\parstraight{B} < m_*$.
            Then, we can apply \Cref{lem:existance_of_equitable_excellent_subpartition} with $r = \frac{m_*}{m_{**}}$ to each of
            the parts $A_j'$.
            Putting together all the new subparts, we obtain a new partition $\overline{A} = \Partriangle{A_i \mid i \in \parcurly{1, \dots, i(*)}}$
            with remainder $B$, satisfying all the conditions of the statement.
        \end{proof}
    \end{lemma}

    Notice that our partition still has reminder, which is unwanted and, as the next lemma proves,
    it is avoidable at the cost of another slight increase of the excellence parameter.

    \begin{lemma}[Claim 5.14.2] \label{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}
        Under the same condition of \Cref{lem:existance_of_excellent_partition_with_equal_size}, we can get a
        partition $\overline{A} = \Partriangle{A_i \mid i \in \parcurly{1, \dots, i(*)}}$ with no remainder, such that:
        \begin{enumerate}[label=(\alph*), ref=\alph*]
            \item \label{itm:existance_of_excellent_partition_with_equal_size_and_no_remainder.a}
                For all $i, j \in \parcurly{1, \dots, i(*)}$, $\parstraight{\parstraight{A_i}- \parstraight{A_j}} \leq 1$.
            \item \label{itm:existance_of_excellent_partition_with_equal_size_and_no_remainder.b}
                For all $i, j \in \parcurly{1, \dots, i(*)}$, $A_i \cap A_j = \emptyset$.
            \item \label{itm:existance_of_excellent_partition_with_equal_size_and_no_remainder.c}
                For all $i \in \parcurly{1, \dots, i(*)}$, $A_i$ is $\parround{\epsilon'', \epsilon'}$-excellent, where
                \[
                    \epsilon'' \leq \frac{\frac{\epsilon'}{k} m_{**} + \ceil{\frac{m_*}{i(*)}}}{m_{**} + \ceil{\frac{m_*}{i(*)}}}
                \]
            \item \label{itm:existance_of_excellent_partition_with_equal_size_and_no_remainder.d} $A = \bigcup \overline{A}$.
        \end{enumerate}
        \begin{proof}
            Let $\overline{A}' = \Partriangle{A_i' \mid i \in \parcurly{1, \dots, i(*)}}$ and $B$ from
            \Cref{lem:existance_of_excellent_partition_with_equal_size}.
            We can partition $B$ into $\overline{B} = \Partriangle{B_i \mid i \in \parcurly{1, \dots, i(*)}}$ in such a way that
            for all $i \in \parcurly{1, \dots, i(*)}$,
            \[
                |B_i| \in \parcurly{\floor{\frac{\parstraight{B}}{i(*)}}, \ceil{\frac{\parstraight{B}}{i(*)}}}
            \]
            Notice that we are allowing $B_i = \emptyset$.
            Then, the new partition $\overline{A} = \Partriangle{A_i' \cup B_i \mid i \in \parcurly{1, \dots, i(*)}}$ satisfies
            \dref{itm:existance_of_excellent_partition_with_equal_size_and_no_remainder.a},
            \dref{itm:existance_of_excellent_partition_with_equal_size_and_no_remainder.b} and
            \dref{itm:existance_of_excellent_partition_with_equal_size_and_no_remainder.d} by construction.
            To conclude, notice that for each $\epsilon'$-good set $B$, the number of exceptions is bounded by
            \begin{align*}
                \parstraight{\parcurly{a \in A_i \mid t(a, B) \not\equiv t(A_i, B)}}
                    & \leq \frac{\epsilon'}{k} \parstraight{A_i'} + \parstraight{B_i} \\
                    & = \frac{\frac{\epsilon'}{k} \parstraight{A_i'} + \parstraight{B_i}}{\parstraight{A_i'} + \parstraight{B_i}}
                        \parround{\parstraight{A_i'} + \parstraight{B_i}} \\
                    & \leq \frac{\frac{\epsilon'}{k} m_{**} + \ceil{\frac{m_*}{i(*)}}}{m_{**} + \ceil{\frac{m_*}{i(*)}}}
                        \parstraight{A_i}
            \end{align*}
            which proves that \dref{itm:existance_of_excellent_partition_with_equal_size_and_no_remainder.c} can be satisfied.
        \end{proof}
    \end{lemma}

    We now have an $(\epsilon'', \epsilon')$-excellent equitable partition with no remainder.
    Also $\epsilon''$ is bounded by something very close to $\frac{\epsilon'}{k}$, where $k$ is a settable parameter
    which only affects the large-enough condition on the size of the graph.
    It is reasonable to assume that, under some conditions of $m_*$ and $m_{**}$, and under an appropriate choice of $k$,
    we can upper bound $\epsilon''$ by $\epsilon'$, thus ensuring that the partition is $\epsilon'$-excellent.

    \begin{remark}[Remark 5.14.3] \label{rmk:epsilons_proportion_can_be_k}
        In the context of \Cref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}, if:
        \begin{enumerate}[label=(\alph*), ref=\alph*]
            \item \label{itm:epsilons_proportion_can_be_k.a} $m_{**} \geq \frac{1}{\frac{\epsilon'}{k}}$
            \item \label{itm:epsilons_proportion_can_be_k.b} $m_* \leq \frac{\frac{\epsilon'}{k} n + 1}{\frac{\epsilon'}{k} + 1}$
        \end{enumerate}
        then $\epsilon'' \leq \frac{3 \epsilon'}{k}$.
        \begin{proof}
            Notice that, if $\parstraight{B_i} \leq 2 \frac{\epsilon'}{k} \parstraight{A_i}$ for all $i \in \parcurly{1, \dots, i(*)}$,
            then $\epsilon''$ can be bounded by:
            \[
                \epsilon'' \leq \frac{\frac{\epsilon'}{k} \parstraight{A_i} + \parstraight{B_i}}{\parstraight{A_i} + \parstraight{B_i}}
                \leq \frac{\frac{\epsilon'}{k} \parstraight{A_i} + 2 \frac{\epsilon'}{k} \parstraight{A_i}}{\parstraight{A_i}}
                = \frac{3 \epsilon'}{k}
            \]
            Let's now prove that $\parstraight{B_i} \leq \frac{2 \epsilon'}{k} \parstraight{A_i}$ is satisfied.
            Notice that, by construction:
            \[
                \parstraight{B_i} \leq \ceil{\frac{\parstraight{B}}{i(*)}} \leq \ceil{\frac{m_* - 1}{i(*)}} \leq
                \frac{m_* - 1}{i(*)} + 1
            \]
            Also we can bound $i(*)$ by:
            \[
                \frac{n}{m_{**}} \geq i(*) \geq \frac{n - \parstraight{B}}{m_{**}} \geq \frac{n - m_* + 1}{m_{**}} >
                \frac{n - m_*}{m_{**}}
            \]
            \todo{Is the lower bound needed?}
            Thus, $\parstraight{B_i} - 1 \leq \frac{m_* - 1}{i(*)} \leq \frac{\parround{m_* - 1} m_{**}}{n - m_*}$,
            then $\frac{\parstraight{B_i} - 1}{m_{**}} \leq \frac{m_* - 1}{n - m_*}$, and since $\parstraight{A_i} = m_{**}$
            we get:
            \[
                \frac{\parstraight{B_i}}{\parstraight{A_i}} \leq \frac{m_* - 1}{n - m_*} + \frac{1}{m_{**}}
            \]
            Finally, notice that condition \dref{itm:epsilons_proportion_can_be_k.a} implies:
            \[
                \frac{\epsilon'}{k} \geq \frac{1}{m_{**}}
            \]
            and condition \dref{itm:epsilons_proportion_can_be_k.b} implies:
            \[
                \frac{\epsilon'}{k} \geq \frac{m_* - 1}{n - m_*}
            \]
            We conclude:
            \[
                \frac{\parstraight{B_i}}{\parstraight{A_i}} \leq \frac{m_* - 1}{n - m_*} + \frac{1}{m_{**}} \leq 2 \frac{\epsilon'}{k}
            \]
            completing the proof.
        \end{proof}
    \end{remark}

    We now resume all the conditions necessaries for the previous result to hold in the context of the values
    $m_*$ and $m_{**}$ given by the previous remark.

    \begin{lemma}[Corollary 5.15] \label{lem:resume_of_all_conditions_for_excellent_partitions}
        Let $G$ be a graph with the non-$k_{*}$-order property.
        Suppose that we are given:
        \begin{enumerate}
            \item $\epsilon \leq \min \parround{\frac{1}{5}, \frac{1}{2^{k_{**}}}}$.
            \item A sequence of positive integers $\Partriangle{m\ell \mid \ell \in \parcurly{0, \dots, k_{**}}}$, and values $m_*$
                and $m_{**}$, such that:
                \begin{enumerate}[label=(\alph*), ref=2.\alph*]
                    \item \label{itm:resume_of_all_conditions_for_excellent_partitions.a} $\frac{\epsilon}{12} m_\ell \geq m_{\ell + 1}$.
                    \item \label{itm:resume_of_all_conditions_for_excellent_partitions.b} $m_{**} \coloneqq m_{k_{**}} > \frac{3}{\epsilon}$.
                    \item \label{itm:resume_of_all_conditions_for_excellent_partitions.c} $m_{**} \mid m_\ell$ for all $\ell \in \parcurly{0, \dots, k_{**}}$.
                    \item \label{itm:resume_of_all_conditions_for_excellent_partitions.d} $m_{k_{**}-1} > N\parround{3, k_*, \epsilon, \frac{m_*}{m_{**}}}$ (in the sense
                        of \Cref{lem:existance_of_equitable_excellent_subpartition}).
            \end{enumerate}
            \item $A \subseteq G$ such that $|A| = n$, where $n$ is large enough to satisfy:
            \begin{enumerate}[label=(\alph*'), ref=3.\alph*]
                \item \label{itm:resume_of_all_conditions_for_excellent_partitions.a'} $n \geq m_0$. \todo{This is implied by next condition.}
                \item \label{itm:resume_of_all_conditions_for_excellent_partitions.b'} $m_* \leq \frac{1 + \frac{\epsilon}{3}n}{1 + \frac{\epsilon}{3}}$.
            \end{enumerate}
        \end{enumerate}
        Then, there exists $i(*) \leq \frac{n}{m_{**}}$ and a partition of $A$ into disjoint pieces
        $\overline{A} = \Partriangle{A_i \mid i \in \parcurly{1, \dots, i(*)}}$ such that:
        \begin{enumerate}[label=(\roman*), ref=\roman*]
            \item \label{itm:resume_of_all_conditions_for_excellent_partitions.i} For all $i, j \in \parcurly{1, \dots, i(*)}$, $\parstraight{\parstraight{A_i}- \parstraight{A_j}} \leq 1$.
            \item \label{itm:resume_of_all_conditions_for_excellent_partitions.ii} For all $i \in \parcurly{1, \dots, i(*)}$, $A_i$ is $\epsilon$-excellent,
            \item \label{itm:resume_of_all_conditions_for_excellent_partitions.iii} For all $i, j \in \parcurly{1, \dots, i(*)}$, $\parround{A_i, A_j}$ is $\epsilon$-uniform.
        \end{enumerate}
        \begin{proof}
            Simply apply \Cref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder} in the context of
            \Cref{rmk:epsilons_proportion_can_be_k} with $k = 3$,
            ${\epsilon'_{\ref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}}} = \epsilon$
            and ${\epsilon_{\ref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}}} \leq \frac{1}{12} \epsilon$.
            This results in a partition of $A$ into disjoint pieces that satisfy
            \dref{itm:resume_of_all_conditions_for_excellent_partitions.i} and that are
            $\parround{{\epsilon''_{\ref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}}},
                \epsilon'_{\ref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}}}$-excellent,
            with ${\epsilon''_{\ref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}}} \leq
                \frac{3 \epsilon'_{\ref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}}}{k}$.
            But since $k \geq 3$, ${\epsilon''_{\ref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}}} \leq
                \epsilon'_{\ref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}}$, they are also
            $\epsilon'_{\ref{lem:existance_of_excellent_partition_with_equal_size_and_no_remainder}}$-excellent, satisfying
            \dref{itm:resume_of_all_conditions_for_excellent_partitions.ii} and
            \dref{itm:resume_of_all_conditions_for_excellent_partitions.iii}.
        \end{proof}
    \end{lemma}

    To conclude, we prove the existence of the decreasing sequence of integers, under some minimal conditions
    of the two parameters $\epsilon$ (the excellence parameter) and $m$ (the minimum number of parts in the resulting
    partition), and rewrite the statement accordingly.

    \begin{theorem}[Theorem 5.18] \label{thm:minimal_conditions_for_excellent_partitions}
        Let $k_*$ and therefore $k_{**}$ be given.
        Then, for all $\epsilon \leq \min \parround{\frac{1}{5}, \frac{1}{2^{k_{**}}}}$ and $m > 1$, there is $M = M\parround{\epsilon, m, k_*}$
        and $N = N\parround{\epsilon, m, k_*}$ such that, for every finite graph $G$ with the non-$k_{*}$-order property, and
        every $A \subseteq G$ with $|A| \geq N$, there exists a partition $\overline{A} = \Partriangle{A_i \mid i \in \parcurly{1, \dots, i(*)}}$
        of $A$, such that:
        \begin{enumerate}
            \item \label{itm:minimal_conditions_for_excellent_partitions.0} The number of parts is bounded by
                $m \leq i(*) \leq M \coloneqq \max \parround{\ceil{\frac{12}{\epsilon}}^{k_{**}+1}, 4m}$. \todo{Move the bound on $M$ to another point?}
            \item \label{itm:minimal_conditions_for_excellent_partitions.1} For all $i, j \in \parcurly{1, \dots, i(*)}$, $\parstraight{\parstraight{A_i}- \parstraight{A_j}} \leq 1$.
            \item \label{itm:minimal_conditions_for_excellent_partitions.2} For all $i \in \parcurly{1, \dots, i(*)}$, $A_i$ is $\epsilon$-excellent.
            \item \label{itm:minimal_conditions_for_excellent_partitions.3} For all $i, j \in \parcurly{1, \dots, i(*)}$, $\parround{A_i, A_j}$ is $\epsilon$-uniform.  \todo{Redundant?}
        \end{enumerate}
        \begin{proof}
            Our goal is to apply \Cref{lem:resume_of_all_conditions_for_excellent_partitions}.
            Let $q = \ceil{\frac{12}{\epsilon}}$.
            For $N\parround{\epsilon, m, k_*}$, and thus $n$, large enough, we can then choose the smallest $m_{**}$ satisfying:
            \begin{enumerate}[label=(\alph*), ref=\alph*]
                \item \label{itm:minimal_conditions_for_excellent_partitions.a} $m_{**} \in \parsquared{\delta n -1, \delta n}$, where
                    $\delta = \min \parround{\frac{\epsilon}{\parround{3 + \epsilon} q^{k_{**}}}, \frac{1}{m + q^{k_{**}}}}$
                \item \label{itm:minimal_conditions_for_excellent_partitions.b} $m_{**} > \frac{3}{\epsilon}$.
                \item \label{itm:minimal_conditions_for_excellent_partitions.c} $m_{**} > \frac{N_{\ref{lem:existance_of_equitable_excellent_subpartition}}
                    \parround{3, k_*, \epsilon, q^{k_{**}}}}{q}$.
            \end{enumerate}
            We set $m_{k_{**}} = m_{**}$ and we build recursively a sequence of integers
            $\Partriangle{m_\ell \mid \ell \in \parcurly{0, \dots, k_{**}}}$ such that $m_\ell = q m_{\ell + 1}$ for all
            $\ell \in \parcurly{0, \dots, k_{**}-1}$.
            Also, let $m_* \coloneqq m_0 = q^{k_{**}} m_{**}$.
            By \dref{itm:minimal_conditions_for_excellent_partitions.a} we have that $m_* \leq \frac{\epsilon n}{3 + \epsilon}$.
            This sequence satisfies all the conditions of \Cref{lem:resume_of_all_conditions_for_excellent_partitions}:
            \begin{itemize}[label={}]
                \item \dref{itm:resume_of_all_conditions_for_excellent_partitions.a} $m_{\ell+1} = \frac{1}{q} m_\ell \leq \frac{\epsilon}{12} m_\ell$.
                \item \dref{itm:resume_of_all_conditions_for_excellent_partitions.b} $m_{**} \geq \frac{3}{\epsilon}$.
                \item \dref{itm:resume_of_all_conditions_for_excellent_partitions.c} $m_{**} \mid m_\ell$ for all $\ell \in \parcurly{0, \dots, k_{**}}$, since $q$ is an integer.
                \item \dref{itm:resume_of_all_conditions_for_excellent_partitions.d} $m_{k_{**}-1} = q m_{**} >
                    q \frac{N_{\ref{lem:existance_of_equitable_excellent_subpartition}}\parround{3, k_*, \epsilon, q^{k_{**}}}}{q} =
                    N_{\ref{lem:existance_of_equitable_excellent_subpartition}}\parround{3, k_*, \epsilon, \frac{m_*}{m_{**}}}$.
                \item \dref{itm:resume_of_all_conditions_for_excellent_partitions.b'} $m_* < \frac{\epsilon n}{3 + \epsilon} < \frac{1 + \frac{\epsilon}{3}n}{1 + \frac{\epsilon}{3}}$.
                \item \dref{itm:resume_of_all_conditions_for_excellent_partitions.a'} $m_0 = m* < \frac{\epsilon n}{3 + \epsilon} < n$
            \end{itemize}
            We can apply \Cref{lem:resume_of_all_conditions_for_excellent_partitions} to obtain a partition
            satisfying \dref{itm:minimal_conditions_for_excellent_partitions.1},
            \dref{itm:minimal_conditions_for_excellent_partitions.2} and
            \dref{itm:minimal_conditions_for_excellent_partitions.3}.

            We proceed to bound the number of parst $i(*)$.
            First, the upper bound follows from the fact that
            $m_{**} \geq \frac{1}{2} \min \parround{\frac{\epsilon} {3 + \epsilon}, \frac{1}{m + q^{k_{**}}}} n$:
            \[
                i(*) \leq \frac{n}{m_{**}} \leq \frac{2 \max \parround{\frac{3 + \epsilon}{\epsilon} q^{k_{**}}, m + q^{k_{**}}}n}{n}
                     < 2 \max \parround{\frac{3 + \epsilon}{\epsilon} q^{k_{**}}, 2m}
                     \leq \max \parround{\ceil{\frac{12}{\epsilon}}^{k_{**}+1}, 4m}
            \]
            In the last inequality, we used that if $m < q^{k_{**}}$, then $m + q^{k_{**}} \leq 2q^{k_{**}} < \frac{3 + \epsilon}{\epsilon} q^{k_{**}}$,
            which is dealt in the first argument of the maximum, so we may assume that $m \geq q^{k_{**}}$.
            We also show that the lower bound is satisfied:
            \[
                i(*) \geq \frac{n - m_*}{m_{**}}
                     \geq \frac{n - m_{**}q^{k_{**}}}{m_{**}}
                     = \frac{n}{m_{**}} - q^{k_{**}}
                     \geq \frac{m + q^{k_{**}}}{n} n - q^{k_{**}}
                     = m
            \]
        \end{proof}
    \end{theorem}

    \begin{remark}
        We now see how large $N$, and thus $n$, actually needs to be.
        First of all, we see that:
        \begin{align*}
            \frac{1}{q} N_{\ref{lem:existance_of_equitable_excellent_subpartition}}\parround{4, k_*, \epsilon, q^{k_{**}}}
                & = \frac{1}{q} N_{\ref{lem:equitable_partition_of_excellent_parts}}\parround{k_*, \frac{1}{4 \cdot 3} \epsilon, q^{k_{**}}} \\
                & = \frac{1}{q} q^{k_{**}} \parround{\frac{12}{\epsilon}}^2
                    \parround{k_* \log{\parround{\frac{12}{\epsilon}}^2 k_*} - \log{\frac{1}{q^{k_{**}}+1}}} \\
                & < k_*^2 q^{2 k_{**} + 3}
        \end{align*}
        Also, $\frac{3}{\epsilon}$ is clearly smaller than this value.
        Then, since $m_{**}$ is the smallest integer larger than both values, we conclude:
        \begin{align*}
            \frac{m_{**}}{\delta}
                & \leq \frac{k_*^2 q^{2 k_{**} + 3}}
                    {\min \parround{\frac{\epsilon}{\parround{3 + \epsilon} q^{k_{**}}}, \frac{1}{m + q^{k_{**}}}}} \\
                & = k_*^2 q^{2 k_{**} + 3} \max \parround{\frac{3 + \epsilon}{\epsilon} q^{k_{**}}, m + q^{k_{**}}} \\
                & \leq \max \parround{q^{k_{**} + 1}, 4m} k_*^2 q^{2 k_{**} + 3}
        \end{align*}
    \end{remark}

    \todo{Define or remove uniformity.}

    As mentioned in the beginning of the section, it can be proven that excellence is a stronger condition then
    regularity.
    In fact, as shown in the following lemma, excellence of a pair not only implies some level of regularity, but
    also it ensures that the pair is mostly full or empty of edges.
    \todo{Mention homogeneity?}

    \begin{lemma}[Lemma 5.17] \label{lem:excellence_implies_regularity}
        Suppose that $\epsilon_1, \epsilon_2, \epsilon_3 \in \parround{0, \frac{1}{2}}$ with
        $\frac{\epsilon_1 + \epsilon_2}{\epsilon_3} < \frac{1}{2}$ and the pair $\parround{A,B}$ is
        $\parround{\epsilon_1, \epsilon_2}$-uniform.
        Let $A' \subseteq A$ with $\parstraight{A'} \geq \epsilon_3 \parstraight{A}$,
        $B' \subseteq B$ with $\parstraight{B'} \geq \epsilon_3 \parstraight{B}$ and
        denote $Z = \parcurly{\parround{a,b} \in \parround{A \times B} \mid a R b \not\equiv t\parround{A,B}}$ and
        $Z' = \parcurly{\parround{a,b} \in \parround{A' \times B'} \mid a R b \not\equiv t\parround{A,B}}$.
        Then, we have:
        \begin{enumerate}
            \item \label{itm:excellence_implies_regularity.1} $\frac{\parstraight{Z}}{{\parstraight{A} \parstraight{B}}} < \epsilon_1 + \epsilon_2$.
            \item \label{itm:excellence_implies_regularity.2} $\frac{\parstraight{Z'}}{\parstraight{A} \parstraight{B}} <
                \frac{\epsilon_1 + \epsilon_2}{\epsilon_3}$.
        \end{enumerate}
        In particular, if for some $\epsilon_0, \epsilon \in \parround{0, \frac{1}{2}}$, the pair
        $\parround{A,B}$ is $\epsilon_0$-uniform, for $\epsilon_0 \leq \frac{\epsilon^2}{2}$, then:
        \begin{enumerate}[label=\alph*., ref=\alph*]
            \item \label{itm:excellence_implies_regularity.a} $\parround{A,B}$ is $\epsilon$-regular.
            \item \label{itm:excellence_implies_regularity.b} If $A' \in \parsquared{A}^{\geq \epsilon \parstraight{A}} and $
                $B' \in \parsquared{B}^{\geq \epsilon \parstraight{B}}$, then $d \parround{A',B'} < \epsilon$ or
                $d \parround{A',B'} \geq 1 - \epsilon$.
        \end{enumerate}
        \begin{proof}
            Let $U = \parcurly{a \in A \mid \parstraight{\overline{B}_{B,a}} > \epsilon_1 \parstraight{A}}$, i.e. the set
            of exceptional vertices $a \in A$.
            Then,
            \[
                Z \subseteq U \times B \cup \bigcup_{a \in A \setminus U} \parcurly{a} \times \overline{B}_{B,a}
            \]
            and
            \[
                Z' \subseteq U \times B' \cup \bigcup_{a \in A' \setminus U} \parcurly{a} \times \overline{B}_{B,a}
            \]
            Notice that, if $a \in A \setminus U$, then $\parstraight{\overline{B}_{B,a}} < \epsilon_2 \parstraight{B}$, so
            \[
                \parstraight{Z} < \epsilon_1 \parstraight{A} \parstraight{B} + \parstraight{A} \epsilon_2 \parstraight{B}
            \]
            which can be written as
            \[
                    \frac{\parstraight{Z}}{\parstraight{A} \parstraight{B}} < \epsilon_1 + \epsilon_2
            \]
            which proves \dref{itm:excellence_implies_regularity.1}.
            Similarly,
            \begin{align*}
                \parstraight{Z'} & \leq \parstraight{U} \parstraight{B'} + \parstraight{A'} \max \parcurly{\parstraight{\overline{B}_{B,a}} \mid a \notin U} \\
                                 & < \epsilon_1 \parstraight{A} \parstraight{B'} + \parstraight{A'} \epsilon_2 \parstraight{B}
            \end{align*}
            By dividing both sides by $\parstraight{A'} \parstraight{B'}$ we conclude
            \[
                \frac{\parstraight{Z'}}{\parstraight{A'} \parstraight{B'}} < \epsilon_1 \frac{\parstraight{A}}{\parstraight{A'}} + \epsilon_2 \frac{\parstraight{B}}{\parstraight{B'}}
                \leq \frac{\epsilon_1 \parstraight{A}}{\epsilon_3 \parstraight{A}} + \frac{\epsilon_2 \parstraight{B}} {\epsilon_3 \parstraight{B}}
                = \frac{\epsilon_1 + \epsilon_2}{\epsilon_3}
            \]
            proving \dref{itm:excellence_implies_regularity.2}.
            Let's now prove \dref{itm:excellence_implies_regularity.a} and \dref{itm:excellence_implies_regularity.b}.
            First of all, notice that:
            \todo{This only works so nice when $A$ and $B$ are disjoint. Check what happens when they are not.
                Something more on the line of $d\parround{A,B} > 1 - 4 \parround{\epsilon_1 + \epsilon_2}$}
            \begin{itemize}
                \item \underline{if $t\parround{A,B} = 1$}, then $d\parround{A,B} > 1 - \parround{\epsilon_1 + \epsilon_2}$
                    and $d \parround{A',B'} > 1 - \frac{\epsilon_1 + \epsilon_2}{\epsilon_3}$, which follows
                    \dref{itm:excellence_implies_regularity.1} and
                    \dref{itm:excellence_implies_regularity.2} respectively.
                    Thus,
                    \begin{align*}
                        \parstraight{d \parround{A,B} - d \parround{A',B'}}
                            & \leq \max \parcurly{d \parround{A,B} - d \parround{A',B'}, d \parround{A',B'} - d \parround{A,B}} \\
                            & < \max \parcurly{ 1 - \parround{1 - \frac{\epsilon_1 + \epsilon_2}{\epsilon_3}},
                                1 - \parround{1 - \epsilon_1 - \epsilon_2}} \\
                            & = \frac{\epsilon_1 + \epsilon_2}{\epsilon_3}
                    \end{align*}
                \item \underline{if $t\parround{A,B} = 0$}, similarly $d\parround{A,B} < \parround{\epsilon_1 + \epsilon_2}$
                    and $d \parround{A',B'} < \frac{\epsilon_1 + \epsilon_2}{\epsilon_3}$.
                    Thus,
                    \begin{align*}
                        \parstraight{d \parround{A,B} - d \parround{A',B'}}
                            & \leq \max \parcurly{d \parround{A,B} - d \parround{A',B'}, d \parround{A',B} - d \parround{A,B}} \\
                            & < \max \parcurly{\parround{\epsilon_1 + \epsilon_2}, \frac{\epsilon_1 + \epsilon_2}{\epsilon_3}} \\
                            & = \frac{\epsilon_1 + \epsilon_2}{\epsilon_3}
                    \end{align*}
            \end{itemize}
            In both cases, we have that $\parstraight{d \parround{A,B} - d \parround{A',B'}}$ is bounded by
            $\frac{\epsilon_1 + \epsilon_2}{\epsilon_3} < \frac{1}{2}$.
            Also, $d \parround{A', B'}$ may only differ by $\frac{\epsilon_1 + \epsilon_2}{\epsilon_3}$ with either
            $0$ or $1$.
            In particular, we may choose $\epsilon_3 = \epsilon$ and $\epsilon_1 = \epsilon_2 = \epsilon_0 \leq \frac{\epsilon^2}{2}$.
            This way, the condition $\frac{\epsilon_1 + \epsilon_2}{\epsilon_3} \leq \epsilon < \frac{1}{2}$ is satisfied.
            We conclude that $\parround{A,B}$ is $\epsilon$-regular (\dref{itm:excellence_implies_regularity.a}) and that $d \parround{A',B'}$ is either
            $< \epsilon$ or $\geq 1 - \epsilon$ (\dref{itm:excellence_implies_regularity.b}).
        \end{proof}
    \end{lemma}

    We finally prove the Stable Regularity Lemma using the previous lemma to reformulate
    \Cref{thm:minimal_conditions_for_excellent_partitions} in the context of regularity.

    \begin{theorem}[Theorem 5.19] \label{thm:existance_of_regular_partitions}
        For every $k_* \in \naturals$ and $\epsilon \in \parround{0, \frac{1}{2}}$ and $m > 1$, there exist $N = N\parround{\epsilon, m, k_*}$
        and $M = M\parround{\epsilon, m, k_*}$ such that, for every finite graph $G$ with the non-$k_{*}$-order property,
        and every $A \subseteq G$ with $|A| \geq N$, there is $m < \ell < M$ and a partition
        $\overline{A} = \Partriangle{A_i \mid i \in \parcurly{1, \dots, \ell}}$ of $A$ such that each $A_i$ is
        $\frac{\epsilon^2}{2}$-excellent, and for every $i, j \in \parcurly{1, \dots, \ell}$,
        \begin{enumerate}
            \item \label{itm:existance_of_regular_partitions.1} $\parstraight{\parstraight{A_i}- \parstraight{A_j}} \leq 1$.
            \item \label{itm:existance_of_regular_partitions.2} $\parround{A_i, A_j}$ is $\epsilon$-regular, and moreover if
                $B_i \in \parsquared{A_i}^{\geq \epsilon \parstraight{A_i}}$ and $B_j \in \parsquared{A_j}^{\geq \epsilon \parstraight{A_j}}$,
                then either $d\parround{B_i, B_j} < \epsilon$ or $d\parround{B_i, B_j} \geq 1 - \epsilon$.
            \item \label{itm:existance_of_regular_partitions.3} If $\epsilon \leq \min \parround{\frac{1}{5}, \frac{1}{2^{k_{**}}}}$, then
                $M \leq \max \parround{\ceil{\frac{12}{\epsilon}}^{k_{**}+1}, 4m}$.
        \end{enumerate}
        \begin{proof}
            If $\epsilon \leq \min \parround{\frac{1}{5}, \frac{1}{2^{k_{**}}}}$, then we can apply \Cref{thm:minimal_conditions_for_excellent_partitions}
            to $A$ with $\frac{\epsilon^2}{2}$, and then use \Cref{lem:excellence_implies_regularity} to replace the
            $\frac{\epsilon^2}{2}$-uniformity of pairs by $\epsilon$-regularity.
            Otherwise, to get \dref{itm:existance_of_regular_partitions.1} and \dref{itm:existance_of_regular_partitions.2},
            just do the same process for some $\epsilon' = \min \parround{\frac{1}{5}, \frac{1}{2^{k_{**}}}} \leq \epsilon$.
            Then, since regularity is monotone, we get the wanted $\epsilon$-regularity from the resulting $\epsilon'$-regularity.
            In this last case, the bound on $M$ is $M \leq \max \parround{\ceil{\frac{12}{\epsilon'}}^{k_{**}+1}, 4m}$.
        \end{proof}
    \end{theorem}

    \begin{remark}
        By \Cref{thm:tree_implies_order}, we have that $k_{**} \leq 2^{k_* + 1}-2$ in the context of the non-$k_*$-order
        property.
        Thus, the bound on the number of parts $M$ can clearly be reformulated as a function of only $k_*$, $\epsilon$ and $m$:
        \[
            M \leq \max \parround{\ceil{\frac{12}{\epsilon}}^{2^{k_* + 1}-1}, 4m}
        \]
    \end{remark}

    % up to here it was compiling with no problem.




\section{Graphs and Regularity Lemma} \label{sec:section_2}

    \todo{Mention that during the thesis, a lot of results carry many conditions most of which seem almost trivial,
        but are necessary for the computations to work. In the final result of each section, the results are cleaned out
        and tried to be delivered in a more readable form.}

    \subsection{Graphs and Basic Notation} \label{subsec:subsection_2.1}

        In all this work we will consider only simple graphs, that is, unweighted, undirected graphs with no loops or
        multiple edges.
        The following definition accounts for this.

        \begin{definition}
            A (simple) \emph{graph} is a pair $G = (V, E)$ where $V$ is a finite set whose elements are called \emph{vertices}
            and $E \subseteq \parcurly{\parcurly{v_1, v_2} \mid v_1, v_2 \in V \text{ and } v_1 \neq v_2}$ is a set of
            unordered pairs of distinct vertices, whose elements are called \emph{edges}.
            If $\parcurly{v_1, v_2} \in E$, then $v_1$ and $v_2$ are said to be \emph{the endpoints} of the edge.
        \end{definition}

        \todo{Define neighbor?}

        By abuse of notation, we will often denote a graph $G = (V, E)$ simply by $G$ and write $v \in G$ to mean $v \in V$.
        Similarly, we will write $u v \in G$ to mean $\parcurly{u, v} \in E$.

        As most of this work is tightly related to model theory results, it is useful to note that vertices adjacency
        (whether two vertices are the endpoints of an edge) is a symmetric and irreflexive binary relation on the
        vertex set.
        With this perspective, to denote vertex adjacency between two vertices $v_1$ and $v_2$ we will often use the
        notation $v_1 R v_2$, where $R$ is the adjacency relation in $V$.

        A class of graphs of particular relevance in this work is that of bipartite graphs.

        \begin{definition}
            A graph $G$ is \emph{bipartite} if there exists a partition of its vertex set into two disjoint sets
            $L$ and $R$ such that every edge in $G$ connects a vertex in $L$ to a vertex in $R$.
            That is, no edge connects vertices within the same set of the partition.
        \end{definition}

        Also, it is often useful to be able to restrict a graph to a subset of its vertices.

        \begin{definition}
            Let $G = (V, E)$ be a graph and let $S \subseteq V$ be a subset of its vertices.
            The \emph{subgraph of $G$ induced by $S$}, denoted by $G[S]$, is the graph whose vertex set is $S$ and whose edge
            set consists of all edges in $E$ that have both endpoints in $S$.
            Formally, $G[S] = (S, E_S)$ where $E_S = \parcurly{\parcurly{v_1, v_2} \in E \mid v_1, v_2 \in S}$.
        \end{definition}

        A similar restriction can defined for bipartite graphs, but only controlling edges between the two disjoint sets.

        \begin{definition} \label{def:bi_induced}
            We say that a bipartite graph $H$ with disjoint sets $L$ and $R$ is \emph{bi-induced} in a graph $G$
            if there exist two injective\footnote{
                In this thesis, the injective condition is redundant.
                Still, this is a common way of defining such condition, so it is sensible keep it this way.}
            homomorphisms $\phi_L: L \longrightarrow G$ and $\phi_R: L \longrightarrow G$ such that, for all
            $u \in L$ and $v \in G$, $uv \in H \Leftrightarrow uv \in G$.
        \end{definition}

        Notice that this definition does not require the two sets $\phi_L$ and $\phi_R$ to be disjoint
        (as defined in~\cite[pg. 417]{regularity_partitions_and_the_topology_of_graphons}
        and~\cite[pg. 2]{efficient_arithmetic_regularity_and_removal_lemmas_for_induced_bipartite_patterns}).
        This is very important for the results of this thesis, and needs to be noted that other works define such
        condition without this relaxation~\cite[pg. 3]{induced_subgraph_density_vi_bounded_vc_dimension}.

    \subsection{Szemerédi's Regularity Lemma} \label{subsec:subsection_2.2}
        We now want to formalize the concept of regular pairs of vertex sets, which is central to Szemerédi's Regularity Lemma.
        The idea is that a pair of vertex sets is regular if the edges between them are \say{randomly} distributed,
        an idea that we can formalize using edge density.

        \begin{definition}
            Let $G$ be a graph and let $X, Y \subseteq G$ be two (not necessarily disjoint) non-empty subsets of its vertices.
            The \emph{edge density} between $X$ and $Y$ is defined as
            \[
                d(X, Y) = \frac{\parstraight{e(X, Y)}}{|X| |Y|}
            \]
            where $e(X, Y) = \parcurly{\parround{x, y} \in E \mid x \in X, y \in Y}$ is the set of edges with one endpoint in
            $X$ and the other in $Y$.
        \end{definition}

        When $X$ and $Y$ are disjoint, the edge density $d(X, Y)$ measures the proportion of possible edges between $X$
        and $Y$ that are actually present in the graph.
        If $X$ and $Y$ are not disjoint, this is not the case.
        On one hand, because simple graphs do not allow loops, and so edges between the same vertex are never present in
        $e(X,Y)$, but they are counted in the denominator as \say{possible edges}.
        On the other hand, edges between vertices in the intersection $X \cap Y$ are counted twice both in $e(X,Y)$
        and $\parstraight{X}\parstraight{Y}$.
        However, we will only be interested in knowing the exact proportion of edges in a pair in two specific cases:
        either when $X$ and $Y$ are disjoint, or when they are equal.
        The first case has no problems, while for the second case we note the following.

        \begin{remark} \label{rmk:density_vs_real_density}
            If $X$ is a subset of vertices of a graph $G$ such that $|X| \geq 2$, then the proportion of possible edges
            between vertices in $X$ that are actually present in $G$ is at most twice the density $d(X, X)$.
            That is,
            \[
                \frac{\parstraight{E_X}}{{|X| \choose 2}}
                    = \frac{\parstraight{e(X, X)} / 2}{\parround{|X|-1}|X| / 2}
                    = \frac{|X|}{|X|-1} \frac{\parstraight{e(X, X)}}{|X|^2}
            \]
            where first equality follows from the fact that $E_X$ counts each edge in $e(X, X)$ twice.
            So,
            \[
                d(X, X)
                    \leq \frac{\parstraight{E_X}}{{|X| \choose 2}}
                    \leq 2 d(X, X)
            \]
            This also implies that the proportion of possible edges between vertices in $X$ that are actually not present
            in $G$ lies between $1 - 2 d(X,X)$ and $1 - d(X,X)$.
        \end{remark}

        \begin{definition}
            Given $\epsilon > 0$ and a graph $G$, a pair of (not necessarily disjoint) subsets of vertices $A, B \subseteq G$
            is said to be \emph{$\epsilon$-regular} if for all $A' \subseteq A$ and $B' \subseteq B$ such that
            $|A'| \geq \epsilon |A|$ and $|B'| \geq \epsilon |B|$, we have
            \[
                |d(A', B') - d(A, B)| \leq \epsilon
            \]
        \end{definition}

        Intuitively, this means that the edges of the pair are fairly uniformly distributed, and the pair behaves
        similarly to a random bipartite graph with edge density $d(A, B)$.

        Now, this notion of regularity can be used in the context of a partition of a graph's vertex set.

        \begin{definition}
            Given a graph $G$, we say that $\parcurly{A_1, \ldots, A_k}$ is a partition of the vertex set of $G$ with
            \emph{remainder} set $B$, if $G = A_1 \cup \dots \cup A_k \cup B$, and $A_1, \dots, A_k$ are non-empty sets.
            Implicitly, we allow the remainder to be empty.
        \end{definition}

        The partition we want to study needs to satisfy that most pairs of parts are regular,
        but we allow a small number of such pairs to be irregular.

        \begin{definition}
            Let $G$ be a graph and let $\epsilon > 0$.
            An \emph{$\epsilon$-regular partition} of $G$ is a partition of its vertex set into $k$ parts
            $\parcurly{A_1, \ldots, A_k}$ with remainder set $B$ such that:
            \begin{itemize}
                \item $|B| \leq \epsilon |G|$, and may be empty.
                \item All but at most $\epsilon k^2$ of the pairs $(A_i, A_j)$ with $1 \leq i < j \leq k$ are
                    $\epsilon$-regular.
            \end{itemize}
        \end{definition}

        Also, we want the partition's sets to be roughly of the same size, which can be formalized in two different ways.

        \begin{definition} \label{def:even_and_equitable}
            A partition $\parcurly{A_1, \ldots, A_k}$ of the vertex set of a graph $G$ is said to be \emph{equitable}
            if for all $1 \leq i < j \leq k$, we have that $\parstraight{|A_i| - |A_j|} \leq 1$.
            On the other hand, a partition $\parcurly{A_1, \ldots, A_k}$ with remainder $B$ of the vertex set of a graph $G$
            is said to be \emph{even} if $|A_1| = |A_2| = \cdots = |A_k|$.
        \end{definition}

        \begin{remark}
            The two previous definitions, although very close in concept, have a key difference that needs to be noted.
            As most of the results requires the partition property (such as regularity) to be satisfied only by parts
            in the partition, and not necessarily by the reminder, in even partitions the behaviour of a
            (non-necessarily trivial) fraction of vertices is unknown.
            On the other hand, the relaxation on the size of the parts in the definition of equitable becomes almost
            trivial as the size of the parts increases.
            Then, results with equitable partitions are preferred over those with even partitions, but usually requires
            extra work to achieve.
            In line with this, the results of \Cref{sec:section_4} will treat even partitions, while the key Stable
            Regularity Lemma in \Cref{sec:section_5} uses an equitable one.
        \end{remark}

        The following is the celebrated Szemerédi's Regularity Lemma.
        The statement and proof we provide in this thesis follows the one given in~\cite{extremal_graph_theory},
        with minor notation modifications.

        \begin{theorem}[Szemer\'edi's Regularity Lemma, \cite{regular_partitions_of_graphs}] \label{thm:szemeredi_regularity_lemma}
            For every $\epsilon > 0$ and every positive integer $m$, there exists a positive integer $M = M(\epsilon, m)$
            such that every graph with at least $m$ vertices admits an even $\epsilon$-regular partition
            $\parcurly{A_1, \ldots, A_k}$ and reminder $B$ with $m \leq k \leq M$.
        \end{theorem}

        The principal strength of this lemma lies in the fact that it guarantees the existence of a regular partition
        which number of parts is independent of the size of the graph, and only depends on the regularity parameter
        $\epsilon$ and the minimum number of parts (and thus vertices) $m$.

        Note that the lower bound on the number of parts $m$ can be used to increase the number of edges that connect
        different parts of the partition, over edges in the parts themselves.
        This is useful in some applications of the lemma.

        Before proving the theorem, it is useful to introduce some additional notation and definitions.
        First, we note that the following inequality holds for any $\mu_1, \dots, \mu_k > 0$ and for all
        $e_1, \dots, e_k \geq 0$:
        \begin{equation} \label{eq:cauchy_schwarz_inequality_plus}
            \sum_{i=1}^k \frac{e_i^2}{\mu_i}
                \geq \frac{\parround{\sum_{i=1}^k e_i}^2}{\sum_{i=1}^k \mu_i}
        \end{equation}
        This is a direct consequence of applying the Cauchy-Schwarz inequality $\sum a_i^2 \sum b_i^2 \geq (\sum a_i b_i)^2$
        with the sequences $a_i = \sqrt{\mu_i}$ and $b_i = e_i / \sqrt{\mu_i}$.

        A crucial concept in the proof of the Regularity Lemma is that of the \emph{energy} of a partition.

        \begin{definition}
            Let $G$ be a graph with $n$ vertices and let $A_1, A_2$ be two disjoint subset of its vertex set.
            Then, we define
            \[
                q(A_1, A_2) = \frac{|A_1||A_2|}{n^2} d(A_1, A_2)^2 = \frac{e(A_1, A_2)^2}{n^2 |A_1| |A_2|}
            \]
            For a partition $\overline{A_1}$ of $A_1$ and $\overline{A_2}$ of $A_2$, we define
            \[
                q(\overline{A_1}, \overline{A_2}) = \sum_{A_1' \in \overline{A_1}, A_2' \in \overline{A_2}} q(A_1', A_2')
            \]
            Finally, we define the \emph{energy} of a partition $\overline{A} = \parcurly{A_1, \dots, A_k}$ of the
            vertex set of $G$ as
            \[
                q(\overline{A}) = \sum_{1 \leq i < j \leq k} q(A_i, A_j)
            \]
        \end{definition}

        Let $\overline{A}$ be a partition with reminder set $B$, we define
        $\widetilde{A} \coloneqq \overline{A} \cup \overline{B}$, and we use $\overline{B}$ to denote the set
        of singletons of the remainder set, $\overline{B} \coloneqq \parcurly{\parcurly{b} \mid b \in B}$.
        Then, $q(\widetilde{A}) = q(\overline{A} \cup \overline{B})$

        The energy function $q$ i the main tool to prove the Regularity Lemma.
        We will prove that, if a given partition has a large enough number of irregular pairs, taking the
        associated parts and make them a partition of their own results in a refinement of the original partition
        with a large increase in energy, which only depends on the regularity parameter $\epsilon$.
        But the energy of a partition is upper bounded:
        \begin{align*}
            q(\widetilde{A}) &= \sum_{\substack{C_1, C_2 \in \widetilde{A} \\ C_1 \neq C_2}} q(C_1, C_2) \\
                &= \sum_{\substack{C_1, C_2 \in \widetilde{A} \\ C_1 \neq C_2}} \frac{|C_1||C_2|}{n^2} d(C_1, C_2)^2 \\
                &\leq \frac{\sum |C_1||C_2|}{n^2} \leq 1
        \end{align*}
        Hence, the process of refinement must stop after a finite number of steps.

        We first prove that refining a pair of parts or a whole partition does not decrease its energy.
        \begin{lemma} \label{lem:energy_does_not_decrease_when_refining}
            Let $G$ be a graph.
            \begin{enumerate}
                \item Let $A_1, A_2 \subseteq G$ be disjoint.
                    If $\overline{A}_1$ is a partition of $A_1$ and $\overline{A}_2$ is a partition of $A_2$, then
                    $q(\overline{A}_1, \overline{A}_2) \geq q(A_1, A_2)$.
                \item If $\overline{A}, \overline{A}'$ are partitions of $G$ and $\overline{A}'$ is a refinement of
                    $\overline{A}$, then $q(\overline{A}') \geq q(\overline{A})$.
            \end{enumerate}
            \begin{proof}
                \begin{enumerate}
                    \item \label{lem:energy_does_not_decrease_when_refining.1}
                        Let $\overline{A}_1 = \parcurly{A_{1,1}, \dots, A_{1,k}}$ and
                        $\overline{A}_2 = \parcurly{A_{2,1}, \dots, A_{2,\ell}}$.
                        Then
                        \begin{align*}
                            q(\overline{A}_1, \overline{A}_2)
                                & = \sum_{i=1}^k \sum_{j=1}^\ell q(A_{1,i}, A_{2,j}) \\
                                & = \frac{1}{n^2} \sum_{i=1}^k \sum_{j=1}^\ell \frac{e(A_{1,i}, A_{2,j})^2}{|A_{1,i}||A_{2,j}|} \\
                                & \stackrel{\eqref{eq:cauchy_schwarz_inequality_plus}}{\geq} \frac{1}{n^2}
                                    \frac{\Parround{\sum_{i=1}^k \sum_{j=1}^\ell e(A_{1,i}, A_{2,j})}^2}
                                    {\sum_{i=1}^k \sum_{j=1}^\ell |A_{1,i}||A_{2,j}|} \\
                                & = \frac{1}{n^2} \frac{e(A_1, A_2)^2}
                                    {(\sum_{i=1}^k |A_{1,i}|)(\sum_{j=1}^\ell |A_{2,j}|)} \\
                                & = q(A_1, A_2)
                        \end{align*}
                    \item \label{lem:energy_does_not_decrease_when_refining.2}
                        Let $\overline{A} = \parcurly{A_1, \dots, A_k}$, and for all $i \in \parcurly{1, \dots, k}$ let
                        $\overline{A}_i$ be the partition of $A_i$ induced by $\overline{A}'$.
                        Then,
                        \begin{align*}
                            q(\overline{A})
                                & = \sum_{1 \leq i < j \leq k} q(A_i, A_j) \\
                                & \stackrel{\dref{lem:energy_does_not_decrease_when_refining.1}}{\leq}
                                    \sum_{1 \leq i < j \leq k} q(\overline{A}_i, \overline{A}_j) \\
                                & \leq q(\overline{A}')
                        \end{align*}
                        where last inequality follows from the fact that
                        $q(\overline{A}') = \sum_{1 \leq i \leq k} q(\overline{A}_i) + \sum_{1 \leq i < j \leq k} q(\overline{A}_i, \overline{A})$.
                \end{enumerate}
            \end{proof}
        \end{lemma}

        Next, we show that refining an irregular pair results in a significant increase in energy.
        This amount, does not yet depend only on $\epsilon$, but it will when applied to all irregular pairs
        at the same time.
        \begin{lemma} \label{lem:increase_in_energy_when_refining_an_irregular_pair}
            Let $G$ be a graph with $n$ vertices, $A_1, A_2 \subseteq G$ be disjoint subsets and $\epsilon > 0$.
            If the pair $(A_1, A_2)$ is not $\epsilon$-regular, then there exist partitions
            $\overline{A}_1 = \parcurly{A_{1,1}, A_{1,2}}$ of $A_1$ and
            $\overline{A}_2 = \parcurly{A_{2,1}, A_{2,2}}$ of $A_2$ such that
            \[
                q(\overline{A}_1, \overline{A}_2) \geq q(A_1, A_2) + \epsilon^4 \frac{|A_1||A_2|}{n^2}
            \]
            \begin{proof}
                Suppose that $(A_1, A_2)$ is not $\epsilon$-regular.
                Then there are subsets $A_{1,1} \subseteq A_1$ and $A_{2,1} \subseteq A_2$ with
                $|A_{1,1}| \geq \epsilon |A_1|$ and $|A_{2,1}| \geq \epsilon |A_2|$ such that
                \begin{equation} \label{eq:irregular_pair_density_difference}
                    |\eta| > \epsilon
                \end{equation}
                where $\eta = d(A_{1,1}, A_{2,1}) - d(A_1, A_2)$.
                We now show that $\overline{A}_1 = \parcurly{A_{1,1}, A_{1,2}}$ and
                $\overline{A}_2 = \parcurly{A_{2,1}, A_{2,2}}$, where $A_{1,2} \coloneqq A_1 \setminus A_{1,1}$ and
                $A_{2,2} \coloneqq A_2 \setminus A_{2,1}$, satisfy the statement.

                For ease of notation, we write $c_i \coloneqq |A_{1,i}|$, $d_i \coloneqq |A_{2,i}|$,
                $e_{ij} \coloneqq e(A_{1,i},A_{2,j})$, $c \coloneqq |A_1|$, $d \coloneqq |A_2|$ and $e = e(A_1, A_2)$.
                Then, we have
                \begin{align*}
                    q(\overline{A}_1, \overline{A}_2)
                        & = \frac{1}{n^2} \sum_{i=1}^2 \sum_{j=1}^2 \frac{e_{ij}^2}{c_i d_j} \\
                        & = \frac{1}{n^2} \Parround{
                            \frac{e_{11}^2}{c_1 d_1} + \sum_{i + j > 2} \frac{e_{ij}^2}{c_i d_j}} \\
                        & \stackrel{\eqref{eq:cauchy_schwarz_inequality_plus}}{\geq}
                            \frac{1}{n^2} \Parround{
                                \frac{e_{11}^2}{c_1 d_1} + \frac{(e - e_{11})^2}{cd - c_1 d_1}}
                \end{align*}
                By definition of $\eta$, in the new notation we have that $e_{11} = \frac{c_1 d_1 e}{cd} + \eta c_1 d_1$,
                and so
                \begin{align*}
                    n^2 q(\overline{A}_1, \overline{A}_2)
                        & \geq \frac{1}{c_1 d_1} \Parround{\frac{c_1 d_1 e}{cd} + \eta c_1 d_1}^2
                            + \frac{1}{cd - c_1 d_1} \Parround{e - \frac{c_1 d_1 e}{cd} - \eta c_1 d_1}^2 \\
                        & \geq \frac{1}{c_1 d_1} \Parround{\frac{c_1 d_1 e}{cd} + \eta c_1 d_1}^2
                            + \frac{1}{cd - c_1 d_1} \Parround{\frac{cd - c_1 d_1}{cd} e - \eta c_1 d_1}^2 \\
                        & = \frac{c_1 d_1 e^2}{c^2 d^2} + \frac{2 e \eta c_1 d_1}{cd}
                            + \eta^2 c_1 d_1
                            + \frac{(cd - c_1 d_1) e^2}{c^2 d^2}
                            - \frac{2 e \eta c_1 d_1}{cd}
                            + \frac{\eta^2 c_1^2 d_1^2}{cd - c_1 d_1} \\
                        & \geq \frac{e^2}{cd} + \eta^2 c_1 d_1 \\
                        & \stackrel{\eqref{eq:irregular_pair_density_difference}}{\geq}
                            \frac{e^2}{cd} + \epsilon^4 c d = n^2 q(A_1, A_2) + \epsilon^4 c d
                \end{align*}
                and we obtain the inequality from the statement by simply dividing by $n^2$ at each side of the inequality.
            \end{proof}
        \end{lemma}

        The next lemma shows that applying the previous lemma to all irregular pairs of a partition achieves the desired
        constant increase in energy.

        \begin{lemma} \label{lem:increase_in_energy_when_refining_an_irregular_partition}
            Let $0 < \epsilon \leq \frac{1}{4}$, let $G$ be a graph with $n$ vertices, and let
            $\overline{A} = \parcurly{A_1, \dots, A_k}$ be a partition of its vertex set with remainder set $B$ such that
            $|B| \leq \epsilon n$ and $|A_1| = \dots = |A_k| \eqqcolon c$.
            If the partition $\overline{A}$ is not $\epsilon$-regular, then there is a refinement
            $\overline{A}' = \parcurly{A'_1, \dots, A'_\ell}$ of $\overline{A}$ with remainder set $B'$ such that
            $k \leq \ell \leq k 4^{k+1}$, $|A'_0| \leq |A_0| + \frac{n}{2^k}$, $|A'_1| = \dots = |A'_\ell|$ and
            either $\overline{A}'$ is $\epsilon$-regular, or
            \[
                q(\widetilde{A}') \geq q(\widetilde{A}) + \frac{\epsilon^5}{2}
            \]
            \begin{proof}
                For all $1 \leq i < j \leq k$, let $\overline{A}_{ij}$ be a partition of $A_i$ and $\overline{A}_{ji}$ a
                partition of $A_j$ as follows.
                If the pair $(A_i, A_j)$ is $\epsilon$-regular, then $\overline{A}_{ij} \coloneqq \parcurly{A_i}$ and
                $\overline{A}_{ji} \coloneqq \parcurly{A_j}$.
                Otherwise, we can apply \Cref{lem:increase_in_energy_when_refining_an_irregular_pair} to obtain a
                partition $\overline{A}_{ij}$ of $A_i$ and a partition $\overline{A}_{ji}$ of $A_j$ with
                $|\overline{A}_{ij}| = |\overline{A}_{ji}| = 2$ such that
                \begin{equation} \label{eq:increase_in_energy_in_refined_ij_pair}
                    q(\overline{A}_{ij}, \overline{A}_{ji}) \geq q(A_i, A_j) + \epsilon^4 \frac{c^2}{n^2}
                \end{equation}
                Now, consider two vertices $u, v \in A_i$ to be equivalent if for every $j \neq i$ they belong to the
                same set of the partition $\overline{A}_{ij}$.
                We can define $\overline{A}_i$ to be the set of such equivalence classes.
                Then, since each partition $\overline{A}_{ij}$ may at most double the number of parts that end up in
                $\overline{A}_i$, we have that $|\overline{A}_i| \leq 2^{k-1}$.
                Putting all of this together, we have a new partition
                \[
                    \overline{A}'' \coloneqq \bigcup_{i=1}^k \overline{A}_i
                \]
                of $G$ with reminder set still $B$.
                Note that $\overline{A}''$ refines $\overline{A}$, and that
                \begin{equation} \label{eq:size_of_refined_partition}
                    k \leq |\overline{A}''| \leq k 2^{k-1} \leq k 2^{k}
                \end{equation}
                By hypothesis, we know that $\overline{A}$ is not $\epsilon$-regular, and so there are at least
                $\epsilon k^2$ pairs $(A_i, A_j)$, with $1 \leq i < j \leq k$, such that the partition $\overline{A}_{ij}$ is
                non-trivial.
                Thus,
                \begin{align*}
                    q(\widetilde{A}'')
                        & = \sum_{1 \leq i < j \leq k} q(\overline{A}_i, \overline{A}_j) + \sum_{1 \leq i \leq k} q(\overline{A}_i, \overline{B})
                            + \sum_{1 \leq i \leq k} q(\overline{A}_i) + q(\overline{B}) \\
                        & \geq \sum_{1 \leq i < j \leq k} q(\overline{A}_{ij}, \overline{A}_{ji})
                            + \sum_{1 \leq i \leq k} q(\parcurly{A_i}, \overline{B}) + q(\overline{B}) \\
                        & \stackrel{\eqref{eq:increase_in_energy_in_refined_ij_pair}}{\geq}
                            \sum_{1 \leq i < j \leq k} q(A_i, A_j) + \epsilon k^2 \epsilon^4 \frac{c^2}{n^2}
                            + \sum_{1 \leq i \leq k} q(\parcurly{A_i}, \overline{B}) + q(\overline{B}) \\
                        & = q(\widetilde{A}) + \epsilon^5 \parround{\frac{c k}{n}}^2 \\
                        & \geq q(\widetilde{A}) + \frac{\epsilon^5}{2}
                \end{align*}
                First equality follows from the definition of energy, first inequality uses
                \dref{lem:energy_does_not_decrease_when_refining.1}~from \Cref{lem:energy_does_not_decrease_when_refining},
                and last inequality follows from the fact that
                $|B| \leq \epsilon n \leq \frac{1}{4}$, so $kc$ is necessarily at least $\frac{3}{4}n$.

                Finally, we need to turn $\overline{A}''$ into an even partition.
                In order to achieve this, we split each part into pieces of equal size, and move the
                remaining vertices to the reminder set.
                We need to separate two cases, as we may not have enough vertices to make substantially sized parts.

                If $c < 4^k$, we just consider all the parts to be singletons, and keep the reminder set $B$ as it is.
                Since there are at most $k$ parts in $\overline{A}$, we have that the resulting partition $\overline{A}'$
                of size $\ell$ satisfies $k \leq \ell = kc < k 4^k$.

                Otherwise, if $c \geq 4^k$, consider $A'_1, \dots, A'_\ell$ to be a maximal collection of disjoint
                sets of size $d \coloneqq \floor{\frac{c}{4^k}} \geq 1$ such that each $A'_i$ is contained in some part of
                $\overline{A}''$.
                Then, the remainder set $B'$ is obtained by adding to $B$ all the remaining vertices from all the parts
                of $\overline{A}''$, or simply $B' = G \setminus \bigcup_{i=1}^\ell A'_i$.

                The resulting partition $\overline{A}' = \parcurly{A'_1, \dots, A'_\ell}$ is a refinement of
                $\overline{A}''$ and, following \dref{lem:energy_does_not_decrease_when_refining.2}~from
                \Cref{lem:energy_does_not_decrease_when_refining}, satisfies
                \[
                    q(\widetilde{A}') \geq q(\widetilde{A}'') \geq q(\widetilde{A}) + \frac{\epsilon^5}{2}
                \]

                Now, no more than $\frac{c}{d} \leq 4^{k+1}$ sets $A'_i$ can lie within the same part of $\overline{A}$,
                so the condition $k \leq \ell \leq k 4^{k+1}$ is satisfied.
                Also, no more than $d$ vertices are left out from each part of $\overline{A}''$, and so
                \begin{align*}
                    |B'|
                        & \leq |B| + d |\overline{A}''| \\
                        & \stackrel{\eqref{eq:size_of_refined_partition}}{\leq}
                            |B| + \frac{c}{4^k} k 2^k \\
                        & = |B| + \frac{kc}{2^k} \\
                        & \leq |B| + \frac{n}{2^k}
                \end{align*}
                Thus, the partition $\overline{A}'$ with remainder set $B'$ satisfies all the conditions in the statement,
                and we are done.
            \end{proof}
        \end{lemma}

        We now have all the tools required to prove Szemer\'edi's Regularity Lemma.
        The idea will be to start with an arbitrary even partition, with a large enough number of parts and small
        enough reminder set, and then keep refining it until we reach a regular partition.
        Then, reaching regularity is inevitable, as the previous result guarantees a constant increase in energy
        which we previously proved to be upper bounded.

        \begin{proof}[Proof of \Cref{thm:szemeredi_regularity_lemma}]
            Let $\epsilon > 0$, $m \geq 1$ and assume without loss of generality that $\epsilon \leq \frac{1}{4}$.
            This is possible by monotonicity of the regularity condition.
            Also, set $s \coloneqq \frac{2}{\epsilon^5}$.

            While refining repeatedly the partition using \Cref{lem:increase_in_energy_when_refining_an_irregular_partition},
            ($s$ times) we need to make sure that the remainder set does not grow too large, as the lemma requires it to
            be at most $\epsilon n$.
            At each refinement, the size of the reminder set increases by at most $\frac{n}{2^k}$, where $k$ is the
            number of parts of the partition before refining.
            Since at each iteration the number of parts can only increase, at most $\frac{n}{2^k}$ vertices
            are added to the reminder set.
            By choosing $k$ and $n$ large enough, we can ensure that the initial size of the remainder set and the
            total growth of it over all the $s$ steps are at most $\frac{\epsilon n}{2}$ each.

            With this in mind, we choose $k$ large enough to satisfy $\frac{s}{2^k} \leq \frac{\epsilon}{2}$, and
            $n$ large enough so that $k \leq \frac{\epsilon n}{2}$.
            Then,
            \begin{equation} \label{eq:final_remainder_size_bound}
                k + \frac{s n}{2^k} \leq \frac{\epsilon n}{2} + \frac{\epsilon n}{2} = \epsilon n
            \end{equation}

            Now, let's bound the number of parts of the partition at the end of the process.
            Since at each step the number of parts goes from $r$ up to at most $r 4^{r+1}$, starting with $k$ parts
            we can simply set $M \coloneqq \max\parround{f^s(k), 2\frac{k}{\epsilon}}$, where $f(r) = r 4^{r+1}$.
            The second term ensures that $n \geq M$ is sufficiently large for~\eqref{eq:final_remainder_size_bound} to hold.

            Now, given a graph $G$ with $n \geq m$ vertices, we can build a partition into $k'$, with $m \leq k' \leq M$
            parts, and with remainder $B$ as follows.
            If $n \leq M$, simply take the partition to be all the vertices as singletons, and the remainder set to be empty.
            The resulting partition is trivially $\epsilon$-regular, as pairs of singletons are always either complete or empty.
            Suppose now that $n > M$.
            We randomly partition the vertex set of $G$ into $k$ maximal parts of equal size, and put the remaining
            vertices in the remainder set.
            This remainder set has size at most $k - 1 < \epsilon n$ by~\eqref{eq:final_remainder_size_bound}.
            We now can apply \Cref{lem:increase_in_energy_when_refining_an_irregular_partition} repeatedly,
            as the choice of $k$ and $n\geq M$ in~\eqref{eq:final_remainder_size_bound} ensures that the reminder is
            at most $\epsilon n$ during $s$ steps.
            But this process must stop in at most $s$ steps, as the energy of the partition increases by at least
            $\frac{\epsilon^5}{2}$ at each step, so after $s$ steps the energy would be at least $1$, which is the theoretical
            maximum as shown earlier.
        \end{proof}

        For the matters of this thesis, it is important to note that it is actually known that:
        \begin{itemize}
            \item \label{itm:regular_partition_with_no_remainder}
                The remainder set can be avoided in the resulting partition of Szemerédi's Regularity Lemma,
                moving from an even partition to an equitable one (\Cref{def:even_and_equitable}).
            \item \label{itm:regular_partition_with_regular_self_pairs}
                It can be ensured that not only (most) pairs of different parts are regular, but also (most) parts
                with themselves (self-pairs) satisfy this property.
        \end{itemize}
        The proof of these escapes the goal of this work.
        The interested reader is redirected
        to~\cite{graph_removal_lemmas, graph_theory_and_additive_combinatorics_exploring_structure_and_randomness}\footnote{
            In~\cite{graph_theory_and_additive_combinatorics_exploring_structure_and_randomness}, authors show how to
            obtain a regular parition that includes regularity within pairs themselves, but omit the details on how to get
            an equitable partition.
            \cite{graph_removal_lemmas} proves the existence of a partition has regular self-pairs and no reminder, but
            the proof of the critical lemma to refine a partition into an equitable one (at the loss of a small amount
            of energy) is omitted.}
        \todo{Lluis: \cite{on_regularity_lemmas_and_their_algorithmic_applications} no demostra casi
            res. Ni el menciono.}
        for more detailed proofs on how to obtain such partitions.